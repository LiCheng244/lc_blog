(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{453:function(t,s,a){"use strict";a.r(s);var n=a(6),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",[t._v("渲染性能优化指南")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("前言")]),t._v(" "),a("p",[t._v("本篇介绍在 CocosCreator 环境下，对游戏程序渲染性能方面各种手段的考察。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"一-渲染性能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-渲染性能"}},[t._v("#")]),t._v(" 一. 渲染性能")]),t._v(" "),a("h3",{attrs:{id:"_1-帧率"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-帧率"}},[t._v("#")]),t._v(" 1.帧率:")]),t._v(" "),a("p",[t._v("是用户对程序的流畅程度比较直观的感受——如果游戏长时间处于一个低于设计帧率的状态，用户就会觉得“卡”。\n从开发者的角度看，帧率降低，是缘于程序的各种运算和操作消耗了过大的系统资源，导致程序必须花费超过“预想的一帧时间”去完成它的工作。\n所以一般来说，帧率不符合预期往往同时还伴随着设备发热，设备耗电加剧，设备内存占用过高导致崩溃等负面情况。")]),t._v(" "),a("p",[t._v("在一些应用场景中，"),a("strong",[t._v("游戏的帧率往往不仅受到绘制操作的影响。")]),t._v(" 其他方面的计算消耗，或者过大的内存占用，都会和帧率产生相互影响。")]),t._v(" "),a("h3",{attrs:{id:"_2-影响性能的情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-影响性能的情况"}},[t._v("#")]),t._v(" 2.影响性能的情况:")]),t._v(" "),a("p",[t._v("以下是cocos游戏程序应用场景中，可能对整体性能有负面影响的情况：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("图形绘制部分造成了过大的开销")]),t._v(" （比如最常见的就是Drawcalls 过高, "),a("a",{attrs:{href:"../04%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/drawcall"}},[t._v("如何降低Drawcalls")]),t._v(")；")]),t._v(" "),a("li",[a("strong",[t._v("非绘制部分的计算工作过于繁重")]),t._v(" （比如每帧都会进行的大型for循环，数值计算，以碰撞检测和过于繁重的物理引擎计算最为常见）；")]),t._v(" "),a("li",[a("strong",[t._v("过高的内存占用和帧率的相互影响")]),t._v("："),a("a",{attrs:{href:"../04%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/drawcall"}},[t._v("纹理压缩")]),t._v(")；")])]),t._v(" "),a("ol",[a("li",[t._v("在浏览器环境下（h5，也包括微信小游戏），系统的内存回收是在程序的空闲时间见缝插针地执行。而过高的系统开销会导致内存收回找不到这样的空闲时间——也就是说，帧率降低的同时可能还存在内存垃圾无法回收的情况；")])]),t._v(" "),a("p",[t._v("2） 因为自动垃圾回收机制的存在，过高的内存占用必然会导致内存回收耗费更长的时间。这个时间开销，也会反过来影响帧率。")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("图形绘制")]),t._v(" "),a("p",[t._v("“渲染性能”这个概念，其实还包含其他诸多方面。但接下来的内容将只局限于其中的一个范畴，即，"),a("strong",[t._v("图形绘制对游戏程序帧率的影响")]),t._v(" 。也就是说，只讨论上述情况中的第一种。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"二-opengl-绘制命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-opengl-绘制命令"}},[t._v("#")]),t._v(" 二. OpenGL 绘制命令")]),t._v(" "),a("p",[a("strong",[t._v("我们目前的、以及将来较长一段时间的游戏项目，都将会采用"),a("a",{attrs:{href:"../00%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/OpenGL",title:"OpenGL或WebGL（简介）"}},[t._v("OpenGL或WebGL")]),t._v("的渲染方式。")])]),t._v(" "),a("p",[t._v("在代码层面，我们要完成一帧游戏画面的绘制，需要调用一系列的 "),a("strong",[t._v("GL绘制命令")]),t._v(" ，其基本操作如下：")]),t._v(" "),a("h3",{attrs:{id:"_1-清屏"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-清屏"}},[t._v("#")]),t._v(" 1. 清屏")]),t._v(" "),a("p",[t._v("将上一帧绘制的内容清空，一般如下：")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glClearColor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.2f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.3f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.3f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glClear")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_COLOR_BUFFER_BIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("接着，按照层级关系，依次对显示元素进行接下来的2,3,4,5步骤：")]),t._v(" "),a("h3",{attrs:{id:"_2-绑定纹理数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-绑定纹理数据"}},[t._v("#")]),t._v(" 2. 绑定纹理数据")]),t._v(" "),a("p",[t._v("首先是绑定纹理数据（亦称之为贴图，图片素材）：")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glActiveTexture")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_TEXTURE0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glBindTexture")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_TEXTURE_2D"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" texture1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_3-顶点数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-顶点数据"}},[t._v("#")]),t._v(" 3. 顶点数据")]),t._v(" "),a("p",[t._v("然后准备好顶点数据（包括顶点位置，索引，颜色），并绑定，比如：")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),t._v(" vertices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// positions          // colors           // texture coords")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0f")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" indices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// first triangle")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// second triangle")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" VBO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EBO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glBindBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_ARRAY_BUFFER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" VBO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glBufferData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_ARRAY_BUFFER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vertices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vertices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_STATIC_DRAW"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glBindBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_ELEMENT_ARRAY_BUFFER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EBO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glBufferData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_ELEMENT_ARRAY_BUFFER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("indices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" indices"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_STATIC_DRAW"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// position attribute")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glVertexAttribPointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FLOAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FALSE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glEnableVertexAttribArray")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// color attribute")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glVertexAttribPointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FLOAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FALSE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glEnableVertexAttribArray")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// texture coord attribute")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glVertexAttribPointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FLOAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GL_FALSE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("float")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glEnableVertexAttribArray")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-shader的加载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-shader的加载"}},[t._v("#")]),t._v(" 4. shader的加载")]),t._v(" "),a("p",[t._v("shader的加载，编译，使用：")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//加载")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// vertex shader 编译")]),t._v("\nvertex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glCreateShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_VERTEX_SHADER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glShaderSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vertex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("vShaderCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glCompileShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vertex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fragment Shader编译")]),t._v("\nfragment "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glCreateShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GL_FRAGMENT_SHADER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glShaderSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fragment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("fShaderCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glCompileShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fragment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建shader实例，并绑定")]),t._v("\nProgramID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glCreateProgram")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glAttachShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vertex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glAttachShader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fragment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glLinkProgram")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//赋值")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glUniform1i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//使用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glUseProgram")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ProgramID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_5-绘制顶点命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-绘制顶点命令"}},[t._v("#")]),t._v(" 5. 绘制顶点命令")]),t._v(" "),a("p",[t._v("准备工作就绪，调用"),a("strong",[t._v("绘制顶点命令")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glDrawElements")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//或者")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("glDrawArrays")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_6-完成渲染"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-完成渲染"}},[t._v("#")]),t._v(" 6. 完成渲染")]),t._v(" "),a("p",[t._v("对所有显示元素均进行步骤2，3，4，5，直到遍历完整个渲染列表。")]),t._v(" "),a("br"),t._v(" "),a("p",[a("strong",[t._v("去掉详细代码的部分，绘制步骤精简为：")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("ol",[a("li",[t._v("清屏。按层级关系依次对显示元素进行2,3,4,5步；")]),t._v(" "),a("li",[t._v("绑定纹理数据（亦称之为贴图，图片素材）；")]),t._v(" "),a("li",[t._v("准备顶点数据（包括顶点位置，索引，颜色），并绑定；")]),t._v(" "),a("li",[t._v("编译使用shader；")]),t._v(" "),a("li",[t._v("调用 "),a("strong",[t._v("绘制顶点命令")]),t._v(" "),a("code",[t._v("glDrawElements()")]),t._v("：")]),t._v(" "),a("li",[t._v("对所有显示元素均进行步骤2，3，4，5。直到遍历完整个渲染列表。")])])]),t._v(" "),a("br"),t._v(" "),a("p",[a("code",[t._v("以上即为我们的游戏程序调用OpenGL API去完成图形绘制的过程。 这个过程导致的系统开销，根本上决定了程序的渲染性能。而对这个过程的优化处理，即是对渲染性能的优化。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"三-导致帧率下降的因素"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-导致帧率下降的因素"}},[t._v("#")]),t._v(" 三. 导致帧率下降的因素")]),t._v(" "),a("p",[t._v("下面是一些常见的除drawcalls之外导致帧率下降的因素:")]),t._v(" "),a("h3",{attrs:{id:"_1-绘制过多的顶点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-绘制过多的顶点"}},[t._v("#")]),t._v(" 1. 绘制过多的顶点:")]),t._v(" "),a("p",[t._v("这种情况在3D游戏中更普遍——为了更细致的表现效果，3D模型的顶点数往往会非常多。 而"),a("strong",[t._v("2D游戏在大部分情况下，一个Sprite只有4个顶点")]),t._v(" ，需要绘制的顶点数量通常比3D游戏更可控。")]),t._v(" "),a("p",[t._v("当然也有一些细节要注意："),a("strong",[t._v("九宫（SLICED）拉伸模式会让"),a("code",[t._v("Sprite")]),t._v("的顶点数变成16个，TILED拉伸模式会让顶点数量不固定的变多，这取决于Sprite尺寸和原始图片尺寸的比例。还有文本框，如果文本框是用单个文字的纹理拼接的，那么一段内容比较大的文本框也会让顶点数暴增。")])]),t._v(" "),a("h3",{attrs:{id:"_2-用了算法复杂的-shader"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-用了算法复杂的-shader"}},[t._v("#")]),t._v(" 2. 用了算法复杂的 Shader:")]),t._v(" "),a("p",[t._v("比如在片元着色器中进行大型for循环和数值计算，这是非常考验设备性能的操作，表现效果在不同终端上往往会有非常大的差别。")]),t._v(" "),a("p",[t._v("这里还要提到顶点着色器和片元着色器的区别：")]),t._v(" "),a("p",[t._v("顶点着色器是对顶点进行逐一操作，而片元着色器是对光栅化后的像素进行逐一操作——通常情况下像素的数量是远多于顶点的。 比如对颜色进行相同的处理，（因为顶点的数量比像素少）用顶点着色器去完成会比片元着色器效率高得多，当然片元着色器能给出更好的表现效果（因为精确到像素）。这些问题是需要设计者权衡的。当然很多特效只能通过片元着色器才能完成，常见的比如Sprite模糊，Sprite描边。）")]),t._v(" "),a("h3",{attrs:{id:"_3-绑定更多的纹理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-绑定更多的纹理"}},[t._v("#")]),t._v(" 3. 绑定更多的纹理:")]),t._v(" "),a("p",[t._v("有一些特殊效果会需要我们绑定多个纹理给GPU，在 shader 中同时处理多个纹理数据。")]),t._v(" "),a("p",[t._v("OPENGL/WEBGL 默认可以同时在GPU绑定32个纹理数据，微信小游戏也支持同时绑定8个纹理数据。绑定和处理更多的纹理也会造成更多的系统开销。")]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"四-优化方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-优化方案"}},[t._v("#")]),t._v(" 四. 优化方案")]),t._v(" "),a("p",[t._v("性能方面："),a("code",[t._v("「发热、敌人数量增多时容易卡顿」")])]),t._v(" "),a("ul",[a("li",[t._v("发热是个比较综合的问题，一般来说 CPU 导致发热，降低 CPU 的工作会有效减少发热;")]),t._v(" "),a("li",[t._v("卡顿则受到帧频和 drawcall 的影响比较大;")])]),t._v(" "),a("p",[t._v("还有以下这些优化手段:")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("降低帧数：目前已动态设置帧频，游戏过程 60 帧，非游戏过程 30 帧")])]),t._v(" "),a("li",[a("p",[t._v("减少帧回调：目前 update 中还有很大的逻辑优化空间")])]),t._v(" "),a("li",[a("p",[t._v("减少内存使用：这块目前也有很大的优化空间，GC 回收，节点池，对象和节点复用、缓存等等，甚至包括一些贴图的引用释放等")])]),t._v(" "),a("li",[a("p",[t._v("drawcall 优化：其实还可以借助一些帧调试工具去进一步分析，项目的后期应该还会对drawcall优化进行再深入一点的探索")])])]),t._v(" "),a("p",[t._v("有一些优化的大原则，在此补充一下，即不要过早优化、最好的优化就是不用优化等等。优化是没什么万金油的，每个项目的性能瓶颈都不一样，需要根据项目的实际瓶颈，判断是该优化内存还是加载时间还是渲染时间等等。")]),t._v(" "),a("br")])}),[],!1,null,null,null);s.default=r.exports}}]);