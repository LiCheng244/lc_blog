<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>关于 内存管理 | LiCheng</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="欢迎光顾!">
    <link rel="preload" href="/assets/css/0.styles.16c06408.css" as="style"><link rel="preload" href="/assets/js/app.ff29e41f.js" as="script"><link rel="preload" href="/assets/js/3.c9686216.js" as="script"><link rel="preload" href="/assets/js/4.aa388247.js" as="script"><link rel="prefetch" href="/assets/js/10.a5450640.js"><link rel="prefetch" href="/assets/js/100.d636f23a.js"><link rel="prefetch" href="/assets/js/101.32ad9f02.js"><link rel="prefetch" href="/assets/js/102.466df319.js"><link rel="prefetch" href="/assets/js/103.31e55354.js"><link rel="prefetch" href="/assets/js/104.5ad53e17.js"><link rel="prefetch" href="/assets/js/105.5d624160.js"><link rel="prefetch" href="/assets/js/106.648845bc.js"><link rel="prefetch" href="/assets/js/107.e98e6546.js"><link rel="prefetch" href="/assets/js/108.576e9b1a.js"><link rel="prefetch" href="/assets/js/109.35378d3a.js"><link rel="prefetch" href="/assets/js/11.cb21e514.js"><link rel="prefetch" href="/assets/js/110.f10be764.js"><link rel="prefetch" href="/assets/js/111.a1e9531e.js"><link rel="prefetch" href="/assets/js/112.c036e4ef.js"><link rel="prefetch" href="/assets/js/113.ee018356.js"><link rel="prefetch" href="/assets/js/114.3297361c.js"><link rel="prefetch" href="/assets/js/115.eef2996d.js"><link rel="prefetch" href="/assets/js/116.37813be9.js"><link rel="prefetch" href="/assets/js/117.e6397943.js"><link rel="prefetch" href="/assets/js/118.84f6bb32.js"><link rel="prefetch" href="/assets/js/119.3c19df00.js"><link rel="prefetch" href="/assets/js/12.45a67b8e.js"><link rel="prefetch" href="/assets/js/120.884c358a.js"><link rel="prefetch" href="/assets/js/121.36b2b003.js"><link rel="prefetch" href="/assets/js/122.ecf212c6.js"><link rel="prefetch" href="/assets/js/123.35c072a8.js"><link rel="prefetch" href="/assets/js/124.fc0d025a.js"><link rel="prefetch" href="/assets/js/125.311b67bf.js"><link rel="prefetch" href="/assets/js/126.0edb4e87.js"><link rel="prefetch" href="/assets/js/127.df8ee7d2.js"><link rel="prefetch" href="/assets/js/128.d09dffd1.js"><link rel="prefetch" href="/assets/js/129.5dd4e9cb.js"><link rel="prefetch" href="/assets/js/13.8147c914.js"><link rel="prefetch" href="/assets/js/130.63347411.js"><link rel="prefetch" href="/assets/js/131.6663b7bb.js"><link rel="prefetch" href="/assets/js/132.2d227f3f.js"><link rel="prefetch" href="/assets/js/133.95e9218d.js"><link rel="prefetch" href="/assets/js/134.862b24b4.js"><link rel="prefetch" href="/assets/js/135.0fd1939e.js"><link rel="prefetch" href="/assets/js/136.240e139c.js"><link rel="prefetch" href="/assets/js/137.f0f2feb3.js"><link rel="prefetch" href="/assets/js/138.f27a5e40.js"><link rel="prefetch" href="/assets/js/139.90fc84a4.js"><link rel="prefetch" href="/assets/js/14.43d77331.js"><link rel="prefetch" href="/assets/js/140.a2461564.js"><link rel="prefetch" href="/assets/js/141.7faef9db.js"><link rel="prefetch" href="/assets/js/142.948e2f76.js"><link rel="prefetch" href="/assets/js/143.e61edddc.js"><link rel="prefetch" href="/assets/js/144.07114a1c.js"><link rel="prefetch" href="/assets/js/145.ed3e1e1f.js"><link rel="prefetch" href="/assets/js/146.d24f94a4.js"><link rel="prefetch" href="/assets/js/147.b209cd49.js"><link rel="prefetch" href="/assets/js/148.7d0a8548.js"><link rel="prefetch" href="/assets/js/149.b26d2087.js"><link rel="prefetch" href="/assets/js/15.437fe92f.js"><link rel="prefetch" href="/assets/js/150.eba4eac4.js"><link rel="prefetch" href="/assets/js/151.cec9d0b1.js"><link rel="prefetch" href="/assets/js/152.796e5006.js"><link rel="prefetch" href="/assets/js/153.cbd6b467.js"><link rel="prefetch" href="/assets/js/154.936ab2c5.js"><link rel="prefetch" href="/assets/js/155.f99dcf4d.js"><link rel="prefetch" href="/assets/js/156.79f75632.js"><link rel="prefetch" href="/assets/js/157.12bdea32.js"><link rel="prefetch" href="/assets/js/158.72cf8571.js"><link rel="prefetch" href="/assets/js/159.942cfc5a.js"><link rel="prefetch" href="/assets/js/16.c6856972.js"><link rel="prefetch" href="/assets/js/160.950f55d5.js"><link rel="prefetch" href="/assets/js/161.eb82d39e.js"><link rel="prefetch" href="/assets/js/162.bbc6124b.js"><link rel="prefetch" href="/assets/js/163.0fcd6451.js"><link rel="prefetch" href="/assets/js/164.51f78889.js"><link rel="prefetch" href="/assets/js/165.44d9cd02.js"><link rel="prefetch" href="/assets/js/166.488e8c50.js"><link rel="prefetch" href="/assets/js/167.a455c6c6.js"><link rel="prefetch" href="/assets/js/168.40fbce4c.js"><link rel="prefetch" href="/assets/js/169.36eeb3c2.js"><link rel="prefetch" href="/assets/js/17.7ce66ede.js"><link rel="prefetch" href="/assets/js/170.0f79fd0c.js"><link rel="prefetch" href="/assets/js/171.062c5345.js"><link rel="prefetch" href="/assets/js/172.aef79d57.js"><link rel="prefetch" href="/assets/js/173.ae0cd104.js"><link rel="prefetch" href="/assets/js/174.e8a40c36.js"><link rel="prefetch" href="/assets/js/175.55d2c7a3.js"><link rel="prefetch" href="/assets/js/176.c24d04fd.js"><link rel="prefetch" href="/assets/js/177.da1dad08.js"><link rel="prefetch" href="/assets/js/178.e9c89936.js"><link rel="prefetch" href="/assets/js/179.49fbf69f.js"><link rel="prefetch" href="/assets/js/18.d0c34109.js"><link rel="prefetch" href="/assets/js/180.2597acf2.js"><link rel="prefetch" href="/assets/js/181.50f3076c.js"><link rel="prefetch" href="/assets/js/182.a8526978.js"><link rel="prefetch" href="/assets/js/183.3b443a24.js"><link rel="prefetch" href="/assets/js/184.b5e4eea5.js"><link rel="prefetch" href="/assets/js/185.07a68de5.js"><link rel="prefetch" href="/assets/js/186.735e1f86.js"><link rel="prefetch" href="/assets/js/187.50ccff72.js"><link rel="prefetch" href="/assets/js/188.d7d36f7e.js"><link rel="prefetch" href="/assets/js/189.47f2b685.js"><link rel="prefetch" href="/assets/js/19.bcda0a66.js"><link rel="prefetch" href="/assets/js/190.c8231184.js"><link rel="prefetch" href="/assets/js/191.2461bef2.js"><link rel="prefetch" href="/assets/js/192.e1f3e33c.js"><link rel="prefetch" href="/assets/js/193.5eecc3e2.js"><link rel="prefetch" href="/assets/js/194.5fe23896.js"><link rel="prefetch" href="/assets/js/195.3ff27c7d.js"><link rel="prefetch" href="/assets/js/196.72fcd20c.js"><link rel="prefetch" href="/assets/js/197.fbcbe37a.js"><link rel="prefetch" href="/assets/js/198.f50350ea.js"><link rel="prefetch" href="/assets/js/199.e14ca59b.js"><link rel="prefetch" href="/assets/js/2.20da2093.js"><link rel="prefetch" href="/assets/js/20.34d3e258.js"><link rel="prefetch" href="/assets/js/200.34cc886d.js"><link rel="prefetch" href="/assets/js/201.36fff99a.js"><link rel="prefetch" href="/assets/js/202.c0d68804.js"><link rel="prefetch" href="/assets/js/203.aa9dc5a7.js"><link rel="prefetch" href="/assets/js/204.0037ab5f.js"><link rel="prefetch" href="/assets/js/21.765ebb4c.js"><link rel="prefetch" href="/assets/js/22.43556677.js"><link rel="prefetch" href="/assets/js/23.6eea6f79.js"><link rel="prefetch" href="/assets/js/24.13ff68d0.js"><link rel="prefetch" href="/assets/js/25.fb9a1a12.js"><link rel="prefetch" href="/assets/js/26.1df44f58.js"><link rel="prefetch" href="/assets/js/27.9456dcef.js"><link rel="prefetch" href="/assets/js/28.f3be8786.js"><link rel="prefetch" href="/assets/js/29.a3751c89.js"><link rel="prefetch" href="/assets/js/30.ff0e40c5.js"><link rel="prefetch" href="/assets/js/31.182a8fd1.js"><link rel="prefetch" href="/assets/js/32.d83a966a.js"><link rel="prefetch" href="/assets/js/33.63c017cc.js"><link rel="prefetch" href="/assets/js/34.c4bdf71f.js"><link rel="prefetch" href="/assets/js/35.b747eedc.js"><link rel="prefetch" href="/assets/js/36.939e99b0.js"><link rel="prefetch" href="/assets/js/37.34b8481c.js"><link rel="prefetch" href="/assets/js/38.aa86ad2e.js"><link rel="prefetch" href="/assets/js/39.3751cafa.js"><link rel="prefetch" href="/assets/js/40.5182b8b5.js"><link rel="prefetch" href="/assets/js/41.fc4904cb.js"><link rel="prefetch" href="/assets/js/42.474dd0d1.js"><link rel="prefetch" href="/assets/js/43.a6331cff.js"><link rel="prefetch" href="/assets/js/44.e0038dd6.js"><link rel="prefetch" href="/assets/js/45.8409c68c.js"><link rel="prefetch" href="/assets/js/46.73681ece.js"><link rel="prefetch" href="/assets/js/47.c20a6ecf.js"><link rel="prefetch" href="/assets/js/48.2c3a7802.js"><link rel="prefetch" href="/assets/js/49.f3ad0646.js"><link rel="prefetch" href="/assets/js/5.d60ba59b.js"><link rel="prefetch" href="/assets/js/50.a2271c10.js"><link rel="prefetch" href="/assets/js/51.886b908e.js"><link rel="prefetch" href="/assets/js/52.421c4957.js"><link rel="prefetch" href="/assets/js/53.23b29712.js"><link rel="prefetch" href="/assets/js/54.7063805d.js"><link rel="prefetch" href="/assets/js/55.411cca23.js"><link rel="prefetch" href="/assets/js/56.b918c62f.js"><link rel="prefetch" href="/assets/js/57.35e410c0.js"><link rel="prefetch" href="/assets/js/58.f904f37d.js"><link rel="prefetch" href="/assets/js/59.9f97848c.js"><link rel="prefetch" href="/assets/js/6.bb83e797.js"><link rel="prefetch" href="/assets/js/60.25ff490f.js"><link rel="prefetch" href="/assets/js/61.a3c722ba.js"><link rel="prefetch" href="/assets/js/62.f5f6f09b.js"><link rel="prefetch" href="/assets/js/63.d7255a53.js"><link rel="prefetch" href="/assets/js/64.4197d718.js"><link rel="prefetch" href="/assets/js/65.e7e35a21.js"><link rel="prefetch" href="/assets/js/66.5598d8d1.js"><link rel="prefetch" href="/assets/js/67.4f3d7f9f.js"><link rel="prefetch" href="/assets/js/68.277398a2.js"><link rel="prefetch" href="/assets/js/69.f3c95723.js"><link rel="prefetch" href="/assets/js/7.11a8c360.js"><link rel="prefetch" href="/assets/js/70.a5157612.js"><link rel="prefetch" href="/assets/js/71.58155e2a.js"><link rel="prefetch" href="/assets/js/72.4a63c916.js"><link rel="prefetch" href="/assets/js/73.e4c7fede.js"><link rel="prefetch" href="/assets/js/74.203837e5.js"><link rel="prefetch" href="/assets/js/75.0284edf9.js"><link rel="prefetch" href="/assets/js/76.b427e26d.js"><link rel="prefetch" href="/assets/js/77.98277665.js"><link rel="prefetch" href="/assets/js/78.db002106.js"><link rel="prefetch" href="/assets/js/79.4693202f.js"><link rel="prefetch" href="/assets/js/8.2f0ad1de.js"><link rel="prefetch" href="/assets/js/80.d616efac.js"><link rel="prefetch" href="/assets/js/81.d51f657f.js"><link rel="prefetch" href="/assets/js/82.80eeda13.js"><link rel="prefetch" href="/assets/js/83.d4e750dd.js"><link rel="prefetch" href="/assets/js/84.78e8b691.js"><link rel="prefetch" href="/assets/js/85.f0726449.js"><link rel="prefetch" href="/assets/js/86.0d84cd85.js"><link rel="prefetch" href="/assets/js/87.038107c0.js"><link rel="prefetch" href="/assets/js/88.12818257.js"><link rel="prefetch" href="/assets/js/89.d78e32ed.js"><link rel="prefetch" href="/assets/js/9.479ebf05.js"><link rel="prefetch" href="/assets/js/90.1433a033.js"><link rel="prefetch" href="/assets/js/91.9298c478.js"><link rel="prefetch" href="/assets/js/92.2fd7f392.js"><link rel="prefetch" href="/assets/js/93.2c9843c2.js"><link rel="prefetch" href="/assets/js/94.06a24dc3.js"><link rel="prefetch" href="/assets/js/95.fc111f07.js"><link rel="prefetch" href="/assets/js/96.af815097.js"><link rel="prefetch" href="/assets/js/97.7b9b96a0.js"><link rel="prefetch" href="/assets/js/98.45095325.js"><link rel="prefetch" href="/assets/js/99.e18932cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16c06408.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="LiCheng" class="logo"> <span class="site-name can-hide">LiCheng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/product/" class="nav-link">
  产品
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/product/" class="nav-link">
  产品
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/game/00基础知识/" class="sidebar-heading clickable"><span>基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/01JavaScript/" class="sidebar-heading clickable"><span>JavaScript</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/05Creator/" class="sidebar-heading clickable"><span>Creator</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/04性能优化/" class="sidebar-heading clickable open"><span>性能优化</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/game/04性能优化/性能指标.html" class="sidebar-link">关于 性能优化指标</a></li><li><a href="/game/04性能优化/批处理.html" class="sidebar-link">关于 批处理（合批）</a></li><li><a href="/game/04性能优化/压缩纹理.html" class="sidebar-link">关于 压缩纹理</a></li><li><a href="/game/04性能优化/静态合图.html" class="sidebar-link">关于 静态合图</a></li><li><a href="/game/04性能优化/动态合图.html" class="sidebar-link">关于 动态合图</a></li><li><a href="/game/04性能优化/渲染性能.html" class="sidebar-link">关于 渲染性能优化</a></li><li><a href="/game/04性能优化/内存管理.html" class="active sidebar-link">关于 内存管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#一-存储形式" class="sidebar-link">一. 存储形式</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#二-引用计数" class="sidebar-link">二. 引用计数</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#三-资源静态引用" class="sidebar-link">三. 资源静态引用</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#四-资源动态引用" class="sidebar-link">四. 资源动态引用</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#五-资源自动释放" class="sidebar-link">五. 资源自动释放</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#六-资源手动释放" class="sidebar-link">六. 资源手动释放</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#七-释放检查" class="sidebar-link">七. 释放检查</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#八-释放过程" class="sidebar-link">八. 释放过程</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/内存管理.html#九-注意点" class="sidebar-link">九. 注意点</a></li></ul></li><li><a href="/game/04性能优化/drawcall.html" class="sidebar-link">如何降低 DrawCall</a></li><li><a href="/game/04性能优化/优化包体大小.html" class="sidebar-link">如何优化包体大小</a></li><li><a href="/game/04性能优化/TexturePacker.html" class="sidebar-link">TexturePacker黑边问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/07Shader/" class="sidebar-heading clickable"><span>Shader</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/game/02TypeScript/" class="sidebar-link">TypeScript</a></li><li><a href="/game/03%E5%BE%AE%E4%BF%A1%E5%B0%8F%E6%B8%B8%E6%88%8F/" class="sidebar-link">微信小游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/06面试题/" class="sidebar-heading clickable"><span>面试题</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1>关于 内存管理方式</h1> <div class="custom-block tip"><p class="custom-block-title">前言</p> <p>设备对每个程序都有最大的内存分配限制，如果超过了这个阈值，会被系统强制关闭，造成 crash。</p> <p>因此在开发的过程中，我们要在保证程序运行效率的前提下，尽量压缩程序运行时所占用的内存。</p> <p>要讨论内存优化，首先要知道项目中最消耗内存的是什么？</p> <p>就像 Creator 工程中占用空间最多的是资源，资源包括纹理、声音、数据等等。</p> <p>这里我们先了解下 Creator 的资源在内存中的管理方式，再介绍其他的优化内容。</p> <p><strong>Creator 2.4.x 版本 加入了： <code>cc.assetManager</code> api，本文开发环境是 Creator 2.4.3</strong>。</p></div> <br> <h2 id="一-存储形式"><a href="#一-存储形式" class="header-anchor">#</a> 一. 存储形式</h2> <p>资源在加载完成后，会以 <code>{ uuid : cc.Asset }</code> 的形式被缓存到 <code>cc.assetManager.assets</code> 中，以避免重复加载。</p> <p><img src="/assets/img/220110400.b65a314c.png" alt=""></p> <p>但是这也会造成内存和显存的持续增长，所以有些资源如果不再需要用到，可以通过 <strong>自动释放</strong> 或者 <strong>手动释放</strong> 的方式进行释放。</p> <p>释放资源将会销毁资源的所有内部属性，比如渲染层的相关数据，并移出缓存，从而释放内存和显存（对纹理而言）。</p> <ul><li><code>cc.assetManager</code>：管理资源的行为和信息，包括加载，释放等</li> <li><code>cc.assetManager.assets</code>：已加载资源的集合</li></ul> <br> <h2 id="二-引用计数"><a href="#二-引用计数" class="header-anchor">#</a> 二. 引用计数</h2> <p><strong>引用计数</strong> 是计算机编程语言中的一种内存管理技术，是指将资源（可以是对象、内存或磁盘空间等等）的被引用次数保存起来，当被引用次数变为零时就将其释放的过程。</p> <p>资源在加载完成后，会返回 <code>cc.Asset</code> 实例， 所有 <code>cc.Asset</code> 实例都拥有成员函数 <code>addRef</code> 和 <code>decRef</code>，分别用于增加和减少引用计数。</p> <br> <p>初始化引用计数:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>资源的引用计数 +1:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">addRef</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_ref<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>资源的引用计数 -1，并尝试进行自动释放:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">decRef</span> <span class="token punctuation">(</span><span class="token parameter">autoRelease</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_ref<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">//接下来会对代码进行详细的解读</span>
    autoRelease <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>_releaseManager<span class="token punctuation">.</span><span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>Asset Manager 只会 <code>『 自动统计 』</code> 资源之间的 <code>『 静态引用 』</code>，并不能真实地反应资源在游戏中被动态引用的情况;</p> <p><code>『 动态引用 』</code> 还需要  <code>『 开发者进行控制 』</code> 以保证资源能够被正确释放。</p></div> <br> <h2 id="三-资源静态引用"><a href="#三-资源静态引用" class="header-anchor">#</a> 三. 资源静态引用</h2> <p>当开发者在编辑器中编辑资源时（例如场景、预制体、材质等），需要在这些资源的属性中配置一些其他的资源，例如在材质中设置贴图，在场景的 Sprite 组件上设置 SpriteFrame。<code>『 那么这些引用关系会被记录在资源的序列化数据中，引擎可以通过这些数据分析出依赖资源列表，像这样的引用关系就是 静态引用』</code>。</p> <h3 id="_1-统计方式"><a href="#_1-统计方式" class="header-anchor">#</a> 1. 统计方式</h3> <p>引擎对资源的 静态引用 的统计方式为：</p> <ul><li><p>在 <strong>动态加载</strong> 某个资源时，引擎会在底层加载管线中记录该资源所有 <strong>直接依赖资源</strong> 的信息，并将所有 <strong>直接依赖资源</strong> 的引用计数加 1，然后将该资源的引用计数初始化为 0；</p></li> <li><p>在释放资源时，取得该资源之前记录的所有 <strong>直接依赖资源</strong> 信息，并将所有依赖资源的引用计数减 1；</p></li></ul> <p>因为在释放检查时，如果资源的引用计数为 0，才可以被自动释放。所以上述步骤可以保证资源的依赖资源无法先于资源本身被释放，因为依赖资源的引用计数肯定不为 0。也就是说，只要一个资源本身不被释放，其依赖资源就不会被释放，从而保证在复用资源时不会错误地进行释放。</p> <br> <h3 id="_2-例子"><a href="#_2-例子" class="header-anchor">#</a> 2. 例子</h3> <ol><li>假设现在有一个 A 预制体，其依赖的资源包括 a 材质和 b 材质。a 材质引用了 α 贴图，b 材质引用了 β 贴图。那么在加载 A 预制体之后，a、b 材质的引用计数都为 1，α、β 贴图的引用计数也都为 1：</li></ol> <p><img src="/assets/img/220110401.21184ae8.jpg" alt=""></p> <br> <ol start="2"><li>假设现在又有一个 B 预制体，其依赖的资源包括 b 材质和 c 材质。则在加载 B 预制体之后，b 材质的引用计数为 2，因为它同时被 A 和 B 预制体所引用。而 c 材质的引用计数为 1，α、β 贴图的引用计数也仍为 1：</li></ol> <p><img src="/assets/img/220110402.47e9929a.jpg" alt=""></p> <br> <ol start="3"><li>此时释放 A 预制体，则 a，b 材质的引用计数会各减 1：</li></ol> <ul><li>材质的引用计数变为 0，被释放，所以贴图 α 的引用计数减 1 变为了 0，也被释放</li> <li>材质的引用计数变为 1，被保留，所以贴图 β 的引用计数仍为 1，也被保留</li> <li>因为 B 预制体没有被释放，所以 c 材质的引用计数仍为 1，被保留</li></ul> <p><img src="/assets/img/220110403.509edaa4.jpg" alt=""></p> <h3 id="_3-通过-creator-来了解-assets"><a href="#_3-通过-creator-来了解-assets" class="header-anchor">#</a> 3. 通过 creator 来了解 assets</h3> <p>新建一个场景，不放入任何资源:</p> <p><img src="/assets/img/220110404.e551b246.png" alt=""></p> <br> <p>打印 assets:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span>
</code></pre></div><br> <p>可以看到内存中的资源均为 cocos 的内置资源:</p> <p><img src="/assets/img/220110405.b65a314c.png" alt=""></p> <br> <p>在场景中放入 HelloWorld:</p> <p><img src="/assets/img/220110406.88d137fd.png" alt=""></p> <br> <p>启动游戏后，引擎在底层加载管线中调用 assets 的成员方法 <code>addRef</code>:</p> <p><img src="/assets/img/220110407.2c6e7054.png" alt=""></p> <br> <p>再次打印 assets 及资源的引用计数:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;spriteFrame.refCount : &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span>refCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/assets/img/220110408.6d0d7a69.png" alt=""></p> <br> <p>会发现 assets 多了两项，uuid 分别是:</p> <div class="language- extra-class"><pre class="language-text"><code>6aa0aa6a-ebee-4155-a088-a687a6aadec4 
31bc895a-c003-4566-a9f3-2e54ae1c17dc
</code></pre></div><br> <p>在编辑器中显示 HelloWorld 的 Texture2D 和 SpriteFrame 的 <code>uuid</code>，和上述的两个 <code>uuid</code> 完全匹配:</p> <p><img src="/assets/img/220110409.fdd3f428.png" alt=""></p> <br> <p>图片的引用计数也增加为 1：</p> <p><img src="/assets/img/220110500.7abf0e27.png" alt=""></p> <br> <p>如果存在两份 HelloWorld，但他们的 spriteFrame 是同一份:</p> <p><img src="/assets/img/220110501.0e162195.png" alt=""></p> <br> <p>那么 <code>cc.assetManager.assets</code> 依然保持原样，但 <code>spriteFrame</code> 的 <code>refCount</code> 会变成 2</p> <p>对于更复杂的资源引用情况，可以自己测试下 assets 及引用计数。</p> <h3 id="_4-texture-和-spriteframe-资源类型"><a href="#_4-texture-和-spriteframe-资源类型" class="header-anchor">#</a> 4. Texture 和 SpriteFrame 资源类型</h3> <p>在 <strong>资源管理器</strong> 中，图像资源的左边会显示一个和文件夹类似的三角图标，点击就可以展开看到它的子资源（<code>sub asset</code>），每个图像资源导入后编辑器会自动在它下面创建同名的 <code>SpriteFrame</code> 资源。</p> <p><img src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAATEAAAAuCAYAAABAki6SAAAW4klEQVR4Ae3Bf1BTB6Lo8e8JJ0AgHIQiUVSk+AO4FzUS07XuVkuXdkHXrl5XyXq7+7rPamm6vtq3TuyOVmtLvU7rTNH+stPnWlt3C60da62l60WitbqdB4kp7g5QOhlKNRikiYRAID/fnD8ywzBK7f54t3jP5yMYDIYY32Pd3d38LSZPnowCBQpucSLfc5MnT0aBAgUKrkeFAgUKFIxTKhQoUKBgnFKhQIECBeOUCgUKFCgYp0RuUX/9618ZGhpitKtXrxIKhZg0aRLvW638249/zPUYDAYUKFDwPSdyixoeHmbSE7tIW1IOsRgDnzfzzl3/iiRJqNVq+vr6KJk5k7ebm/kfj25m8kOPkTjtdlQaDe1LClCgQME4oOIWljy7mIT0DDS3z+L2upf513/5F4YCAS5dusTp06eZNnUq/qYmTL828dX6lSROySVBSgdRTZxer2fnzp3o9XpGMpvNmEwmxiJJEhaLhdLSUkpLS7FYLEiSxI2UlpZisViQJAmZJElYLBYsFguSJCGTJAmLxYLJZOJm6fV6tm7dSk5ODqOZTCYsFgsKFIxPKm5h0YFhooMBWrc8zNGGRvbt20coHCIWizFv3ly6urrIzM7mbo2GBUuWEHB+ATH+y3i9XtRqNVqtFplWq0WtVqNWq8nPz0em1WpRq9W0tbWhQIFC5BYWDUfpXFvG7Wkarl5xU1xczOVLl0lOTub111/HZDKRmZGB0+nkl5WVWF76D/L/41X+Fmazmby8PGR2u53a2lrGYjabycvLQ2a326mtrcXpdBIKhSgoKMDlclFQUIDX60VWWFiIw+EgOzubgYEBnE4nkiRRVVVFVlYWsvr6eqxWK3q9npUrVyKLxWKcOXOGkUpLS6moqCAUCnH16lUUKBi/RG5hkb4BUocH+PdHH8blukxWVhYejwfZvHnzCAQCdHdfod/nI3EwQMTZiio5me/KZDKh1Wqprq4mPz+f1atX43a7sdlsXI/JZCI7O5uamhqys7NZvXo1brcbq9VKV1cXOp0OmU6nw+Px4Ha7KSoqQlZYWEgwGMTn82E2m5FVV1djMBgoKyvD6/UiE0WRhoYGrFYrer2eOL1eT1lZGfX19dhsNqqqqlCgYPwSGSeysrLYsGEDEyZMYLTu7m5ef/11/H4/I0X7/SAICEC/r5/at//Ibbdl8ZOKcpKTk7l86TIHDxwgHImwcN48hGgIQRQZTRRF1q5dy9q1axnJ4/EgSRK5ubl0dXXh8/lwOBwsWrQInU7HjWRmZtLW1obL5cLlcrFo0SKKioqwWq243W6MRiM5OTlMmjSJ06dP09PTg9FoJCcnh8zMTFpbW5EkCa1WS1NTEz6fD5vNhtFopLCwkLa2NsLhMF6vl9EyMjLo6+vDZrPh8/loamrCaDSiQMH4JDJO9Pb28uGHH7Jq1So0Gg1xPp+Po0eP4vf7GS18rY9+IZHbb8/n/LlPOf7RRwwPD5ORkcGMmTM4duwY/9l4iqlTpjB98iSigQBCcgqjhcNh3n33XRwOB3Fms5mRSkpKKCkp4dtotVq0Wi0ej4c4j8dDZmYmsvb2doxGIxMnTiQYDOJ0OpEFg0GmT59OYmIiXq8XrVZLSkoKcT6fD7/fT1wwGKSnp4fRdDodChTcOkTGkZaWFmSrVq1Co9Hg8/k4fPgwnZ2dXE/Y20dkWjEej4evur5mKBgklqLlxf2vsvuZaj748EPQpHDp8mVI1hDxeOnetQWiEb6r+vp6rFYrI0mSxGh+vx+/389ImZmZxLlcLjweD/PmzUPm8/mQXblyBZ1ORzAYxOl0IhscHCROkiS0Wi0ej4exuN1ucnNzUaDg1qBinGlpaeG9997D5XJx+PBhOjs7uZHIwBAZhqU0nvyYrKwsYjGY199HIEFkYGAA7i5jykcnkQX8fjKTRCZv2QWqBG6Wz+ejq6sLo9GIJEnk5OTw1FNPYTKZuBGPx0NhYSE5OTno9XqmTJlCa2srcX6/n2nTptHa2kqc2+0mLy8Pl8uFz+fD5/Ph9/sxGo1IkoTBYCA9PZ22tjbG0t7eTkpKCgaDAUmSMBqNKFAwfqkYh1paWqipqaGzs5OxRAPDhK8NcKzxHMlJyejnzuFzQcXm9Q/R0dHBcimVyz9ewuIf3UX7N72kVv8fQj1X+K5qa2vx+/1s27aNTZs20dPTQ21tLTdSW1tLT08PmzZtYu3atVy8eBGr1UpcW1sbiYmJeL1e4trb25kwYQJ9fX3EHT58GNm2bduoqKigoaEBh8PBWFwuF2fOnKGiooJt27Zx5coVgsEgChSMT4LBYIhxC7Lb7WjuegiVlI0qMYXw8W38bOUakhKT8F7zMDAwyLW+PtI0Gno0Gr4S0pn4P/83YkYGHT+di2HeXBQoUPA9J3LLE4gGA4gV23n7yC4KZ95OqjaNKBBUq2ntdCIalpJ+93Ii/YMgJAAxFChQMA6I3NJixIb6ifZfJdTfg3pqMR29vUScX0MsiioljcRps+Gqm4E/N5I4fSZJMwohhgIFCsYDkVvZUD8J0iTE1AlEdTMREBCEGNFIFJVKRSxRTUKqBlWKBlVyIkJSEpH+QYiEUaBAwTggcgvLvHyW2wYvkp+fT6PVSlFREdnZ2fznyZPc95OfcPz//pVETQoJ6ZkM2j9DM88IgoACBQrGCcFgMMRQoECBgnFIhQIFChSMUyoUKPhvLysri3feeYeXX36Z9PR0FIwbgsFgiKFgpOaaDkYqWDeJsbQfuMJICzbNQsG4sHfvXvLz87meFStWEIlEUHDTRFEkHA4TJ4oi4XCYfyYRBdezYNMsZM01HVRWVjK2vSzYNAtZc00HCsaF2tpaUlNTuZH333+fZcuWoVKpUHBT1q1bR3Z2Ns888wyyJ554gr6+Pl588UVGuvfee7lw4QK9vb38vVQo+GfR6/Xs3LkTvV7PSGazGZPJxFgkScJisVBaWkppaSkWiwVJkriR0tJSLBYLkiQhkyQJi8WCxWJBkiRkkiRhsVgwmUzcLL1ez9atW8nJyWE0k8mExWJhPIrFYqSmpiJbtmwZZ86cIa60tJTFixcjO3HiBN9Feno61dXVnDp1itraWsrLy/lnSk9Pp7q6mlOnTlFbW0t5eTn/CA899BDp6el8F2q1muXLl7Ns2TLOnTvHJ598wn333YfJZOLPf/4zDQ0NPPDAA8gWLFjAq6++yoQJE2hubqa5uZnm5maam5tpbm5Go9Fws0QUXE9zTQdxdXV1jOXp+6C5poP/Sl6vF7VajVarxefzodVqUavVyPLz83E4HGi1WtRqNW1tbfx3l5GRQdyJEycYyWq1Irtw4QKPPPIIEydO5GaoVCpeeuklnE4njz32GFOnTqWkpITGxkaCwSD/aCqVipdeegmn08ljjz3G1KlTKSkpobGxkWAwyN9KEAQefvhhrFYrPp+PWCzGzXjwwQfp7u7mgw8+oKioCEEQGBwc5LPPPuOBBx7gkUceIRKJkJyczO7du9myZQvFxcUYjUYyMjKQJScn88EHH5CRkUEgEOBmiCgYrWDdJCorK5HV1dWRlpbGWArWQWVlJbK6ujrS0vhOzGYzeXl5yOx2O7W1tYzFbDaTl5eHzG63U1tbi9PpJBQKUVBQgMvloqCgAK/Xi6ywsBCHw0F2djYDAwM4nU4kSaKqqoqsrCxk9fX1WK1W9Ho9K1euRBaLxThz5gwjlZaWUlFRQSgU4urVq4xXSUlJ3Mh7773HihUrmD9/Pp999hlxjY2NvPDCC9zIXXfdhU6nY9OmTQwNDdHa2sqpU6dQq9UsXbqU9evXo1KpOHDgAEeOHEG2dOlSHn74YTQaDX/4wx84dOgQK1asYP369ahUKg4cOMCRI0fIysri2WefpaioCIfDwc6dOykuLkan07Fp0yaGhoZobW3l1KlTGI1GtmzZwsWLF7nzzju59957WbNmDQ8++CDhcJh9+/Zx8uRJJk6cyG9+8xsWLlzI8PAwO3bs4MKFCxw9ehRBEKirq+PYsWM888wzrFixgvXr16NSqThw4ABHjhzBYDCwfft2Ll68yJ133snevXv5/e9/T1JSEsXFxUQiEcLhMCtXriQ/P5/777+fgwcPsn79eubOnUs0GsVut5OQkIDH40Gm0Wj4rkQU3Ay1GOOx+3tZuqAfiPFRs8TeD7IIhQX+HiaTCa1WS3V1Nfn5+axevRq3243NZuN6TCYT2dnZ1NTUkJ2dzerVq3G73VitVrq6utDpdMh0Oh0ejwe3201RURGywsJCgsEgPp8Ps9mMrLq6GoPBQFlZGV6vF5koijQ0NGC1WtHr9cTp9XrKysqor6/HZrNRVVXFeNXV1cX1fPPNN6xatQpZOBxGFEVkFy5c4J577mHJkiWsWLGC6ykoKODLL78kEokwMDCALBKJMGfOHDZv3szGjRsRRZE9e/bQ3d3NwMAATz75JI8//jgDAwPodDoWLlzI5s2b2bhxI6IosmfPHrq7u5kzZw6xWIw1a9bwgx/8gFAoREFBAV9++SWRSISBgQFkkUiE4eFhpkyZwieffMKjjz5KeXk5v/rVr9i4cSPp6em88MILfP755wwNDeF0OnnjjTcoLy/HYrHwy1/+knXr1vGnP/2JdevWcfnyZRYtWsTmzZvZuHEjoiiyZ88euru7GRoaYsqUKXzyySc8+uijXLlyhV27dpGRkcG1a9e44447+Pjjjzl27Bgvvvgivb29JCUlceLECdrb23n++edRqVS88cYbzJo1C5kgCHxXKhTcjP+1vJfciSHW7M5lze7p5E4MUVXxDd9GFEXWrl3Lc889x3PPPcdzzz1HXl4eMkmSyM3NpaurC5/Ph8Ph4PLly+h0Om4kMzOTtrY2XC4XDoeDy5cvU1RUhMztdpObm0tOTg6TJk2ira2N9vZ2tFotOTk5ZGZm0traiiRJaLVampqa8Pl82Gw2+vr6KCwsRBYOh/F6vYyWkZFBX18fNpsNn89HU1MT41VSUhLXc+DAAeJ+9rOfEbd9+3ZkCQkJxGIxrkcQBARBIBKJMNI999xDS0sLnZ2d2O12bDYbZWVllJWVcfHiRdrb22ltbaWxsZHFixfT0tJCZ2cndrsdm81GWVkZTU1NFBQUUFVVhc1mY2hoCEEQEASBSCTCaLFYjDfffJOvvvqK+fPnk5mZyf79+9m9ezfJycnMnj0bn8/Hp59+ys9//nN+9KMfMW3aNFJSUohEIsgikQgej4dFixbR0tJCZ2cndrsdm81GWVkZCQkJxGIx3nzzTb766iuGh4c5d+4cTU1NfPPNN8jmzp3Lhg0b2LNnD5WVlQSDQVwuF1988QUytVqNSqXiySefpLy8nJ/+9KecOnWKSCTCzRJRcDOWGftZszuXXp+I7Om3s3nniS5ePJ7FWMLhMO+++y4Oh4M4s9nMSCUlJZSUlPBttFotWq0Wj8dDnMfjITMzE1l7eztGo5GJEycSDAZxOp3IgsEg06dPJzExEa/Xi1arJSUlhTifz4ff7ycuGAzS09PDaDqdjlvJsmXLOHHiBCNZLBbiTpw4Qdzx48eJmzBhAn19fYzW0dHBqlWrEEWR0QRBIBwOE4lEiEajyNRqNbFYjHA4TDgcRhaNRhEEgXA4TCQSIRqNImttbaWyspIHH3yQuro6HnroITo6Oli1ahWiKDJaNBolHA4TCAS4du0aDoeD3/3ud8RiMWSCIGAwGHjqqafYv38/X3zxBVu2bCEhIYFYLMZogiAQDoeJRCJEo1FkoigSjUYJh8MEAgFEUUSj0XDp0iVaWlpYvHgxb7/9Nl9//TUajYaMjAxKSkqw2WxEo1FG8/v9hEIhduzYQUJCAjdLhYK/RSzGP0x9fT0WiwWLxYLFYuGVV17hevx+P36/n5EyMzOJc7lceDwe5s2bh8zn8+Hz+bhy5Qo6nY5gMIjT6cTv9zM4OEicJElotVq+jdvt5laiUqmQRaNRrl27hszr9fJtXC4X13PmzBm8Xi+PP/44ubm5LFy4kP3793P+/HmKi4uZMWMGM2fOxGAwcPbsWc6dO8ecOXMoKipiypQplJeXc/r0aYqLi5kxYwYzZ87EYDBw9uxZ7rnnHnQ6HS+//DJut5v58+fz6aef4vV6efzxx8nNzWXhwoXs37+fxMRERjp16hRz585l1qxZRCIRjEYjXq+XO+64g0uXLmG325k+fTpx/f399PX1MWnSJNLT0zl9+jTFxcXMmDGDmTNnYjAYOHv2LKMtXbqUBQsWsHr1ap544glSUlL49a9/TVVVFcuXL+euu+4iPT2dhIQEZIIgYLFYyM7OZqS7776bRx55hJslouBmnGhK40lTD0+/nU1CAmxd08P7n6Xz9/D5fHR1dWE0GrHZbGi1WjZs2EBbWxsfffQR1+PxeCgsLCQnJ4fs7GymTJlCQ0MDcX6/nxkzZnD+/Hni3G438+bNo7OzE5/Ph8zv92M0GrHZbBgMBtLT02lra2Ms7e3tLFmyBIPBgM1mw2g0Mt4tWLCAyZMnExcIBGhoaGAsKSkpXE8kEsFsNrN161YOHTpEb28vb731FhcvXmTfvn3s3r0b2WuvvYbdbmdgYIB9+/bx9NNPo1KpOHLkCI2Njezbt4/du3cje+2117Db7fzwhz9k27Zt5OTkcO7cORoaGhAEAbPZzNatWzl06BC9vb289dZbJCQkMFJbWxvPPvssO3bsICUlhXPnznH27FmOHz9OSUkJhw4d4vz58wiCgCwSifDHP/6RHTt28PHHH7Nr1y727dvH7t27kb322mvY7XZmz57NSA6Hg0uXLuH3+7l27RqHDx9m586dtLW1EYvF2LVrFzKVSsVtt92GSqUiOzubQCBAYmIicZmZmQSDQVJSUhgcHOTbCAaDIYaCkfr7+6msrERWV1dHWloaajHGY/f3snSBD9lHzRJ7P8giFBbo7++nsrISWV1dHWlpacj0ej0rV67k6NGjOBwO4sxmMx6Ph9raWmRms5m8vDxknZ2dvPLKK0iSRFVVFU1NTciMRiP79+/H5/NhNpvJy8tDZrfbqa2tJU6v17Ny5UqOHj2Kw+FAlpOTw4YNGzhz5gxWqxWZJElUVVWRlZWFrL6+HqvVil6vZ9myZRw8eBCXy4Ver2fZsmUcPHgQl8tFaWkpFRUVyP7yl7+QmZlJTU0NtxK/34/VauV6lixZgiRJjEUQBFJTUxFFkVgsRiAQIBgMkpSUhEajQRYIBBgeHkaWlJSERqNBNjQ0xNDQEElJSWg0GmSBQIDh4WESExNJTk4mISGBUCiE3+9HJggCqampiKJILBYjEAgQjUZJS0vD6/USl5iYiEajQRAEQqEQAwMDqFQqUlNTSUhIIBQKkZiYiNfrRZacnIxGo2F4eJjBwUGSkpLQaDTIAoEAw8PDiKJIWloaXq8XmUqlQqVSEY1GeeCBBzCZTKSkpCBrbW1l+/btXLt2jYqKCmbPns2hQ4dYvnw5v/jFL8jIyEDW19fHb3/7W9rb2wkEAnwbwWAwxFAwUn9/P5WVlcjq6upIS0tjLP39/VRWViKrq6sjLS0NBeNaIBBg/vz5PP/888juu+8+Tp48yfLly1Fw05KTk0lKSkIQBGSRSIT+/n5kiYmJiKLI4OAgycnJJCcno1KpkEWjUfr7+4lEInwbwWAwxFAwUnNNByMVrJvEWNoPXGGkBZtmoeCWFIvFEAQBBd8bIgquZ8GmWciaazqorKxkbHtZsGkWsuaaDhTcsgRBQMH3igoFChQoGKdEFFxPc00HcXV1dYzl6fuguaYDBQoU/H8mGAyGGAoUKFAwDqlQoECBgnFKhQIFChSMUyoUKFCgYJxSoUCBAgXj1P8DC/ooFiJWxaAAAAAASUVORK5CYII=" alt=""></p> <p><code>SpriteFrame</code> 是核心渲染组件 <code>Sprite</code> 所使用的资源，设置或替换 <code>Sprite</code> 组件中的 <code>spriteFrame</code>属性，就可以切换显示的图像。</p> <p>为什么会有 SpriteFrame 这种资源？</p> <p><code>Texture</code> 是保存在 GPU 缓冲中的一张纹理，是原始的图像资源。</p> <p>而 <code>SpriteFrame</code> 包含两部分内容：记录了 <code>Texture</code> 及其相关属性的 <code>Texture2D</code> 对象和纹理的矩形区域，对于相同的 <code>Texture</code> 可以进行不同的纹理矩形区域设置，然后根据 <code>Sprite</code> 的填充类型，如 <code>SIMPLE、SLICED、TILED</code> 等进行不同的顶点数据填充，从而满足 <code>Texture</code> 填充图像精灵的多样化需求。而 <code>SpriteFrame</code> 记录的纹理矩形区域数据又可以在资源的属性检查器中根据需求自由定义，这样的设置让资源的开发更为高效和便利。除了每个文件会产生一个 <code>SpriteFrame</code> 的图像资源（<code>Texture</code>）之外，我们还有包含多个 <code>SpriteFrame</code> 的图集资源（<code>Atlas</code>）类型。</p> <br> <h2 id="四-资源动态引用"><a href="#四-资源动态引用" class="header-anchor">#</a> 四. 资源动态引用</h2> <p>当开发者在编辑器中没有对资源做任何设置，而是通过代码动态加载资源并设置到场景的组件上，则资源的引用关系不会记录在序列化数据中，引擎无法统计到这部分的引用关系，这些引用关系就是 <strong>动态引用</strong> 。</p> <h3 id="_1-动态加载"><a href="#_1-动态加载" class="header-anchor">#</a> 1. 动态加载</h3> <p>使用 <strong>动态加载</strong> 资源来进行动态引用:</p> <h4 id="a-动态加载-resources-目录中的资源"><a href="#a-动态加载-resources-目录中的资源" class="header-anchor">#</a> a. 动态加载 resources 目录中的资源</h4> <p><img src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAb0AAAA/CAYAAAB0IRYjAAAgAElEQVR4Ae3BC3BU9aH48e85Z3ezm8dmQ17knY0hQkIEEjQKsQhS8QHyrBet0v4F6ly0yJXeahk7tPq/itdHK6VV1F4VmtKLFCksCBQrJj5AIBISEkiAhEcSSLLZzSa7m92ze85/9j+TmYyjiIKOwu/zkUpLS3UEBAQEBAQuazICAgICAgKXPRkBAQEBAYHLnoyAgICAgMBlT0ZAQEBAQOCyZ+AK0d7ezoVKS0tDQEBAQOCyYuAK43xoJ18kcdUtRLS3t5OWloaAgICAwGVDRkBAQEBA4LJnQGCA86GdRCSuuoX29na+TFpaGp9n7ty5DB8+nEOHDjF27FgkSaKyspJ33nkHm83G7Nmzyc/PR1EU/H4/NTU1OBwOgsEgESaTiRkzZjBy5EjMZjPhcJjW1lY2b97MqVOnGJCdnc3tt99OTk4OiqLg9/upqanB4XAQDAaJmDt3LsOHD+fVV1+ltbWVAXPnzmX48OG8+uqrtLa2MnfuXIYPH86hQ4cYO3YskiRRWVnJO++8Q3p6OnfeeSc5OTkoioLf76empgaHw0EwGCTCZrMxe/Zs8vPzURQFv99PTU0NDoeDYDBIhMlkYsaMGYwcORKz2Uw4HKa1tZXNmzdz6tQpBAQEBL5JBgQ+y/nQTr5M4qpbOB+LxUJJSQkHDx5E0zQaGxvJyspi3rx5WCwWamtrcTqd5OfnU1ZWRnJyMq+//jrBYJBZs2YxevRoWlpaaG5uJikpicLCQu655x5Wr16Ny+UiNzeXefPmERUVRV1dHS6Xi8LCQsrKykhOTub1118nGAzyVVgsFkpKSjh48CCaptHY2Ehubi7z5s3DYrFw/Phx2traKCwspKysDIPBwPr168nKymLevHlYLBZqa2txOp3k5+dTVlZGcnIyr7/+OsFgkFmzZjF69GhaWlpobm4mKSmJwsJC7rnnHlavXo3L5UJAQEDgm2JA4JsgSRJ79uzB4XAw4L777sNkMrF27VqOHj1KxI4dO7j99tspLy/nmmuuobGxkaysLM6cOcPq1avRdZ2IqVOnct1115GTk4Pb7eaHP/whUVFRbNy4kQMHDhCxY8cO7r33Xq6++mquueYa9u/fz1chSRJ79uzB4XAw4L777sNsNrNp0yb27t1LxK5du3jggQfIyckhKSmJm266CZPJxNq1azl69CgRO3bs4Pbbb6e8vJxrrrmGxsZGsrKyOHPmDKtXr0bXdSKmTp3KddddR05ODi6XCwEBAYFvioHvuOTkZH72s58RHx/P+YTDYTZt2sTevXs5n6nXFXEpfMz5qarKmTNnGBAfH096ejqBQAC73U52djYDrFYrkiSRn59PTU0Nfr+ftLQ0pk2bRlVVFS6XC4fDgcPhICIlJYXU1FTOnTvHoUOHGBAOh9m/fz/Dhg2jqKiI/fv381WoqsqZM2cYEBsbS2pqKi6Xi4aGBgYEg0H+8Ic/EBEfH096ejqBQAC73U52djYDrFYrkiSRn59PTU0Nfr+ftLQ0pk2bRlVVFS6XC4fDgcPhQEBAQOCbZuA7rquri5qaGsrLy5FlmS9y8uRJamtr+a6KjY3FYrEQHR3NpEmT+Dw2mw1VVamsrGTmzJmUl5czfvx4/H4/R48epbKyktbWVoxGIwaDgZ6eHlRVZTC3200oFCImJoaLFRcXR0xMDJ2dnXg8Hj5PbGwsFouF6OhoJk2axOex2WyoqkplZSUzZ86kvLyc8ePH4/f7OXr0KJWVlbS2tiIgICDwTTLwHafrOlu3biWivLwcWZb5rBMnTrBmzRp8Ph/fdS0tLfzpT3/ifA4dOsThw4cZPXo0paWlZGZmMmbMGIqKiti4cSPnzp3j2yDLMpIkcSFaWlr405/+xPkcOnSIw4cPM3r0aEpLS8nMzGTMmDEUFRWxceNGqqurERAQEPimGPge0HWdrVu3ElFeXo4syww4ceIEa9aswefz8V3W399PIBAgPj6exMREnE4n5xMOhzlw4AAHDhxAkiTKysqYNm0aJSUlbN68mVAoRHx8PEajEVVVGWCz2TAYDLhcLgYoioLVaqW1tZUBNpuNL9PT00NfXx8xMTFYrVY8Hg8DfvSjHzF8+HC2bt1KIBAgPj6exMREnE4n5xMOhzlw4AAHDhxAkiTKysqYNm0aJSUlVFdXIyAgIPBNkfme0HWdrVu38sEHH6BpGhEnTpxgzZo1+Hw+vuucTidnzpwhPj6esWPHMtiUKVN46qmnuO2228jOzmbZsmUsWLAASZKI0HUdp9NJOBwmorOzk3PnzpGamso111zDAEVRGDt2LAaDgZaWFiL6+/sxGo0kJyczwG63k5qaypfp6+vj3LlzJCQkMGLECAYkJCSQl5dHf38/x44d48yZM8THxzN27FgGmzJlCk899RS33XYb2dnZLFu2jAULFiBJEhG6ruN0OgmHwwgICAh80wx8j+i6ztatW9F1ndTUVP72t7/h8/n4vqiqqsJutzNp0iTsdjvNzc3k5uaSm5uL0+lkz5499PX10dXVxbBhw/j5z3/OsWPHiIqKori4GFmW2bdvH7qu889//pN58+Yxa9Yshg8fjsvlorCwkOTkZE6cOMGBAweIaGxspLS0lMmTJ5OcnExEcXExwWAQk8nEl6mqqsJut3PnnXeSn5+Py+Vi1KhRxMfHs3PnTjweD1VVVdjtdiZNmoTdbqe5uZnc3Fxyc3NxOp3s2bOHvr4+urq6GDZsGD//+c85duwYUVFRFBcXI8sy+/btQ0BAQOCbpKSnp/+G75mmpiY+/fRTVFXlQvX19RGRNXMpl8KZt18gLi6OzzNy5EhSU1Opr6/n7NmzDHC73TQ1NZGamkpOTg5XXXUVcXFxHD9+nIqKCtxuN5qm0dDQQGJiIllZWeTn55OZmUlfXx8bNmygrq6OCLfbTXNzM6mpqRQUFJCXl4csy3z88cf8/e9/JxgMEtHZ2Ynf7ycnJ4e8vDxSUlKoq6vj+PHjZGdnU11dTW9vLyNHjiQ1NZX6+nrOnj3LALfbTVNTE2lpaRQUFGC321FVlW3btlFVVUWE2+2mqamJ1NRUcnJyuOqqq4iLi+P48eNUVFTgdrvRNI2GhgYSExPJysoiPz+fzMxM+vr62LBhA3V1dQgICAh8k6TS0lKdK0B7ezsRN6xp5VL4eF4GaWlpCAgICAh8L8gICAgICAhc9mQEBAQEBAQuewauMB/Py0BAQEBA4IojIyAgICAgcNkzcIVIS0tDQEBAQOCKJSMgICAgIHDZkxEQEBAQELjsyQgICAgICFz2ZAQEBAQEBC57MgICAgICApc9GQEBAQEBgcueAYGLcfjwYfr7+/kiOTk57N+/H1VViY2NJTY2lk3vvceanTvZ9MwznI/ZbKaoqAgBAQEBgYtmQOBiBAIBhj72FPG3zUbzeUHXMVjj6al6l/U3FjFu3DhUVcVoNFJfX09GRgYl+fmora382/79/OTBX3DV86/ha6jFlGUHXUOOjuHohKsJBAIICAgICFwSBgQuVvToMgxDktAs0UgGA1IwSNvzyxn/WDs+nw+TyYQkSTzzzDOYzWZWrVpFbFIS3sZGDM2H6XZsIFC7n/T/+iN6IIAcHYNkNEFIRUBAQEDgklDS09N/g8DX1d7eTvztszGmpKEHgxjj4mn6r0e5PuRh1r/NRQfUYJCOzk6MRiNFRUWMGDECv9/PiWPHiJ00iY8eW0J/Uz0pDy4j7O1DMhjofOUFJF0jLS2NwRYtWsQdd9xBU1MTvb29fNbEiRNZtGgRoVCIlpYWLlRGRgZLly5l6NCh1NXVkZGRwdKlSxk6dCh1dXVcCKvVyuLFi5kwYQINDQ34/X4GWK1WFi9ezIwZM0hPT6empobBysrKeOihh0hOTqauro6LMXHiRBYuXEh3dzdnz57li0ycOJGFCxfS3d3N2bNnERAQuMzJCFwszRtAdbrQfH4aHn2AHzqbeXvXv1i5ciXbtm1DDanouk75+PGMGnUNp06dIikxkSEpKdxksTB//XrGTpiA/0QjiiUadL6XPB4PHR0dxMbGkp6ezmAZGRlYrVZ0XSclJQWr1cpgaWlpRDQ3NyMgICDwTZARuGiygu/Ax3je3Yq6+x1+dO88tFCY1atX097WTjCo4vP66O/vRw2G6Pf76e/vJy42lkBfH9GHDjFl6jQ8n3yAbDaj6xrfV8ePH0dRFLKyshjMbrcTcezYMaxWKxkZGQyQJInMzEy8Xi/Nzc0ICAgIfBMMCFwsLaiiBYJ0//l3FCQnUjxmDM6uLv7whz+gKAqdHR2YzWY++eQTampqmDt3LlFRURiNRvp8PhKBhJhoenfuIO2+n0E/l5QkSdxwww1MmjSJuLg4dF2no6MDh8NBY2MjF0pRFG6++Wauv/56YmJi0HWdjo4OHA4HjY2NRJw8eZJAIEB6ejoDJEkiNzcXj8dDXV0dubm52O12GhoaiEhOTsZms9Hd3U1nZycRNpuNGTNmkJ+fj8lkIhgM0tTUxNtvv43H4yFi4sSJTJ48mf379zN69GiioqKoq6ujtbWVz0pPT2f27NlkZGQQ0dDQQFtbGwJXvIkTJ/LAAw+wdetW1q5di8BlzYBAWloaCxcu5OjRo6xfvx5d1/kqwj1eQv4gMQEvP37wAUKqirOri6SkJCRZoru7m4iDNQcZPWo0fr+fM2fO4PP56fV40CWJ3s4uwica6D9xDFN2LpfS7NmzGTt2LF1dXVRXV2OxWCguLmbevHls3LiR6upqvowkScyZM4eSkhK6urrYv38/NpuNwsJC5s2bx8aNG6mursbpdNLT00NCQgJWqxWPx0NycjJDhgzh9OnTNDY20tfXR25uLpIkoes66enpWCwWWlpa0HWdhIQE5s+fT1JSEseOHeP06dPk5+dTWFhIcnIyf/7zn3G5XEQYDAauu+46jhw5gsfjoaWlBZvNxmBDhw7l/vvvJyYmhoaGBlwuFyNHjiQjIwOBK9aWLVsY7K677uKuu+4iYurUqUiShMAlIcsyEZqmMcBgMBAKhfi2GRCQZRlZlikpKSFi/fr16LrOBVNVgv0Bhtji0cIa3j4vwUCQs+1nCQaDJCYmYjKZyLPnkZqSirevD0WWqa09RCgUxmSOItDXC0E/mrcXZIXziY6O5uGHH+ZC5OXlUVxcTENDA3/5y18Ih8NEVFZWsmDBAsaNG0dtbS1fprCwkOLiYk6ePMlrr71GMBgk4uqrr+aee+5h3Lhx1NbW4vP5aGtro7CwkOTkZDweD3a7HYvFwvHjx3E6nXR2djJ06FCSk5Pp6OggNzcXTdNobm4mYuLEiSQlJfHee++xY8cOInbu3Mkdd9zBjTfeSFlZGdu3bydCkiSOHj3KmjVr0HWdiIkTJzLYuHHjiI2N5d133+Wf//wnEVVVVfzsZz9D4Iqj6zoOh4PzcTgc3HHHHciyjMBFu+mmm1i0aBFz5swhwmq1smXLFubPn8+xY8cYbNy4cfT09HD48GEsFgtRUVEMpus6PT09fF0GBAZIkkRJSQkR69evR9d1LoTWH8BgNOPu8aAoMuc6zmEymtiy+R8YFAPxNhtTbruVlOQUejw9hENhag8dYv8n+wiFwxSMGM4QUxSSwUC4rxdJljifUChEW1sbqqryWXFxcaSkpDAgLy8Ps9mMpmlMmjSJwTRNIykpiZSUFL7MsGHDUBSFAwcOEAwGGdDY2MiZM2fIysoiOzub48eP09zcTHFxMWlpaRw/fhy73Y6qqrS0tBBx4sQJ8vLysNvtdHZ2kp6ejsfjobW1lejoaHJzc+np6WH//v0M0HWdAwcOMGbMGAoKCnj33XcZcPLkSXRd5/MYjUYyMzPp6emhurqaAS6Xi9raWsaPH4/AFcXhcDBg1KhR1NTUMOCnP/0pqampPPPMM2zdupVp06YhcNHuuusucnJy+Oijj4hwu93ExMSwdu1adF0n4oUXXmDDhg3Y7XYWLlzIgw8+yB133MFdd93FYH19fUycOBFd1/k6DAgMJkkSJSUlRKxfvx5d1/kyIXcPhqE5OCUTdnsePW43TY2NbNm2Db/fjyzLJCQkkHfVVUgS/OMf/+C999+nt7eXzIwMZEUhKyUZze9HjolFMkdzPsFgkLfffpvW1lY+a+LEidx2220MSEpKQpIkiouLKS4u5rNUVWXIkCF0d3dzPmazGVVV6erqYjBd1+nt7UVRFOLi4og4deoUwWCQrKwsoqOjSU9Pp7u7m3PnzhFx8uRJQqEQdrudY8eOER8fT1tbGx6PB6vViqIoeL1ePB4Pg3m9Xvr7+4mKisJisXAhLBYLUVFReL1ePB4Pg3k8HnRdR+CKoes6AzRNIzs7m8G6urpwu90MCIVCGAwGLpTBYGD+/PlMmTIFq9XKBx98wAsvvIDH4+HbYDAYmD9/PlOmTMFqtfLBBx/wwgsv4PF4uFj/8R//wa5du6itreWrmDp1Kna7nV/+8pc88cQTPP744zz99NMsXryYWbNm0dHRwauvvkpEVFQUFRUVZGdn89Of/pTHHnuMVatWYTabiRg+fDhPP/008fHxuN1uvg4DAp8lSRIlJSVErF+/Hl3XOZ+wvx+TbCJktqKqKj6fD7+/H7/fjyzLaLpOZVUl6RnpKIqBbdu3EwqFkGSZM62tWOPjyUwbihRlQfd78X68G0niklFVlbfeeouDBw/yRTIyMrhUurq6cLlcJCcnk5mZic1mo7q6GlVViWhvb8ftdpOSkkJ2djYxMTG0tLTwbVNVFU3TELhi+Hw+BsiyzJYtWxjM4XDQ3d3Ntddey5IlS3jqqadYt24dDQ0NXIgnnniCYcOG8fLLL+P3+5k2bRolJSW8//776LrON+2JJ55g2LBhvPzyy/j9fqZNm0ZJSQnvv/8+uq5zMSZNmsSRI0doaGggFApxocLhML///e85evQoNTU1FBQUUF9fT3l5OVdffTU33XQTlZWV7NmzB5vNxpAhQ1i7di3hcBiz2YzX68Xn8xHh8XjQdZ2LISPwRUwmExdC7w+ghyWk5Gx6e3vRNZ2Ozk4kRUEzmiAmjprDh+k414EWDhMKhcAajx5lJqLj3Dkko4lQexsn58/A89476OEwl4LH48FoNJKens7F6O/vx2g0kpSUxGCSJBEXF0coFMLpdBKhqiqnTp0iISGB/Px8ZFmmpaWFAT6fj7a2NqxWK/n5+WiaxpkzZ4gIhUKEw2FiYmKwWq0MFhMTg9lsxu/309vby4Xw+/0EAgFiYmKwWq0MlpiYiKIoCFwxNE3jfEpKShgyZAj79u3jxz/+MWPGjOG///u/2bJlC8uXL+d8ioqKuOWWW/j1r3/N3r172bNnD8uWLWPfvn0YDAauvfZaKioq2L17NytWrCAxMZEBo0eP5o033uD999/n97//PUlJSURce+21VFRUsHv3blasWEFiYiIRZrOZFStWUFlZybp16ygvL6eoqIhbbrmFX//61+zdu5c9e/awbNky9u3bR25uLvv27ePuu+9m165dTJ48mQkTJrB+/Xp2797Nb3/7WywWCzExMTz00ENs2LCB9957jyVLlhCxbt060tLSePLJJ9m1axcR1157LRUVFezevZsVK1aQmJhIRGZmJvv27ePuu+9m165dqKrKD37wA/7617+SmZnJnDlzSE9PR1VVXnvtNR544AFaWlowGAwsXbqULVu2sGnTJrKzswkEAlgsFiwWCxaLBbPZzMWSEfgsXdc5cuQI//u//4uu63yZsLefQFsbCaW386+d2+nvD5CUlISuQ9TsuxjV24NfMdDj8eD1euGmyRT3uMnYtpMIW0IC/r4+hkQZSFj0KGmPPgWywqVw5MgR/H4/xcXFJCQkMCAhIYFHH32URx99lKSkJL5MU1MT4XCY0tJSTCYTAwoKCsjMzKS7uxun08mAlpYWZFlmxIgReL1eTp8+zWDNzc0YjUby8/Nxu920t7cT4fP5aGlpIT4+nrFjxzJAkiRKS0uJjY3l1KlT6LrOhVBVlZaWFuLj4xk7diwDEhISKCwsROCKEh0dzRcpLS2lurqaiM2bNzNYIBBg7NixvPrqq3yRkSNH0tHRQUdHB729vaiqSigUwuv1kpGRwYsvvojD4WDJkiVER0fz3HPPIUkSWVlZrFq1it27d7N48WJqa2vRNI3c3FxefPFFHA4HS5YsITo6mueeew5JkpgxYwYjR45k4cKFvPnmm/j9fkaNGkVHRwcdHR309vaiqiqhUAiv14uqqkiSxJQpU1i+fDkRTz75JC+99BKLFy8mMTGRRYsWEQ6HMZvNPPvsszz99NPcfffdjBs3jn//939HVVV+97vfcf/991NcXMyLL76Iw+FgyZIlREdH89xzzyFJEhGSJDFlyhSWL19OY2Mj//M//8OyZct44403aGxsJBQKkZyczK233sqjjz7KzTffTCgU4tlnn2XOnDm4XC5iY2O59dZbqaqqoqqqiqqqKl5++WUulgGBwXRd58iRI1RUVBAMBrkQelBF8/lRoqP5ZO/H5BUMZ8iQBNDCBD78gKM//inDsrKwxsXR2dkJnx7gyJy5aGfPIsky9txcwpKEKymDq3/0fwj3urlUmpubqa+vp6SkhMWLF3Pw4EFkWaaoqIjY2Fjeffddurq6yMjI4Hzq6+upra2lpKSEhx9+mMOHD2Oz2SgsLCSiqqoKn8/HgLa2NlRVJTU1lcbGRpxOJ4M1Nzejqio2m41PP/0Un8/HgPfee4+8vDwmTpxIVlYWp0+fJj8/n+zsbDo7O6mqquKrqKqqoqCggJtuuomsrCza2toYNWoUCQkJqKqKwBVDURTC4TCKovBZBw4cYMCrr77KnXfeScTy5cvZt28f27ZtY+jQoXwRSZKQJAlN09A0jcEmT56Mx+Nh+/bt+Hw+3njjDV555RUKCgq48cYbaWtr4x//+Ad+v5+6ujoMBgOzZs3C4/Gwfft2fD4fb7zxBq+88goFBQVUV1ezYMECFixYwLp166itreXqq69GkiQ0TUPTND7PSy+9RH19Pffffz/R0dGsWLGCCFmWMRqNSJLE6tWrmTp1KgUFBYRCIUaMGMEnn3yCruv09vbS2trKvHnz8Hg8bN++HZ/PxxtvvMErr7xCQUEBXq+XiJdeeon6+nr8fj+bNm1CVVWcTic2mw1N02hubuaTTz7B5XJx6tQpoqKi8Hg89Pb2oqoquq4T0dTUxIMPPkhEWloac+bM4WIYEBig6zpHjhyhoqKCYDDIhdLDGlpQRVd76PZqfLpvL2NKr2P06NHU1NXR/9c1TH/0l7hcLgKBANMm/IAtG98CSeIH48YTGx3Nsa5OMpf8Fl1S0Pz9XCq6rrN+/Xq6u7u54YYbGDduHBE9PT1s3ryZjz/+mAuh6zobNmzA5XJx/fXXM2HCBHRdp62tja1bt3L8+HEG6+zspLu7m7i4OE6cOMFndXZ24na7iYmJobm5mcFcLhevvfYaM2bMID8/n4KCAoLBIDU1NTgcDjweD1+Fy+XitddeY/bs2eTn5zNs2DC6u7uprq6muLgYgSvK9OnTcTgcnM+WLVsY8Nvf/pbBAoEAUVFRfFZ9fT1JSUmkp6fjdrsZTJIkdF1H13UCgQCqqhJhMplQFAVd19E0jf7+fiLC4TCSJKHrOrquEwgEUFWVCJPJxOHDh5k+fTozZ87kySefZPfu3ezYsYOkpCTS09Nxu918nv7+fnw+H06nk8bGRh566CF0XWeA3W5nxYoVrFmzhvXr1zN69GgURUFRFAZomkaEruvouk4gEEBVVSJMJhN+v5+I/v5+fD4fET/5yU/IyclhyJAh3HbbbeTl5ZGUlMSwYcNITEwkMTGRt956i4qKCnRd57NCoRAej4fu7m5OnDiBJEl8XVJpaanOFS4tLY2FCxdy+vRpKioqCAaDXKjq6mosNy5ASchEDweRTdF4a7YRdeojps+8C4OioCgGXO5uQqEwgUAAd08PFosZAxIdFgsN7/+L6Jtmknz/I0hGBSXWStPUa5DCIUpKShAQELiEVFVl+/btfB2TJk0iJiaGz/P888+TlZXFypUr6e3tZfr06bS1tfGvf/2LiooKVq1axYcffsiiRYtISUnhkUceISkpiTVr1vDHP/6Rqqoqxo0bx86dO7FarVRUVLBq1So+/PBDFi1aREpKCo888ghlZWWoqsrBgwdZuHAhxcXFLFiwgCeffJKsrCxWrlxJb28v06dPp62tje3bt7Np0ybmz59PbW0tycnJvPXWW/z5z39mx44djBw5kmPHjlFeXs7cuXP5xS9+QVZWFo8//jhr167lL3/5C3//+99599132bRpExEVFRWsWrWKDz/8kEWLFpGSksIjjzxCbGwsGzduZP78+dTW1vKTn/yEBx98EK/Xi9PpxGw2o+s6lZWVdHZ20t3djd1ux+FwcPr0afr7+9m2bRuffvopV111Fbqu88ADD+DxeIi47777SEhIYOXKlXwdMgLt7e28+OKLrFmzhmAwyMXQgn5irplCILOMIw31OLu7cbtdtLef5dy5c3g8Pci6TiAQwGMwcPj9fxH9g5kk3vMwWiCI1h9E6w8AOgICAt+A7du3U1payvTp07n55pu58cYbCYfDXAiLxcIX+dWvfsXevXt57LHHeP755zGbzWzbto22tjaWLl3KjBkzePPNN5EkieXLlxMKhWhsbOSXv/wld955J2vWrKGsrIzY2Fiam5tZunQpM2bM4M0330SSJJYvX04oFMLlcnHPPffw9ttvU1RUxLPPPovBYOBXv/oVe/fu5bHHHuP555/HbDazbds2oqKiGOzcuXMsWbKEW2+9lQ0bNnDvvfeSlJTEjh07aGpq4qWXXuKWW27h5MmTyLJMxKpVq5g6dSorV66ko6ODpUuXMmPGDN58800kSWL58uWEQiE0TWOwv/3tb0yePJmZM2cyf/58Nm/eTEtLCy+//DLr1q1j165dTJgwgfj4eILBIBaLBRAA4WUAAAQeSURBVJvNRmlpKQcPHsRsNhMXF0dsbCxxcXFkZmYSFRWFxWLh65BKS0t1BL6u6upqLDcuQEnIRA+r/H+6hqwY8TieIj4mirS0dGJi49B0HSSJoNFIXzhEV3sbhtLbiZs0E10LocTGICkyckwMzfeORwqHKSkpQUBA4BIKh8MoisJgqqqyfft2zuf5559n9+7dfBmLxYLJZEKSJFRVxefzoes6RqMRi8WCoiioqorX60XXdSKMRiMWiwVFUVBVFZ/Ph6ZpGI1GLBYLiqKgqiperxdd1zEYDFgsFgwGA+FwGK/XSzgcJsJisWAymZAkCVVV8fl8SJKEzWbD7XajaRoRBoOB6OhoFEUhHA7j8/kIh8PExMRgMBgIhULIskwwGKS/vx+TyUR0dDS6rtPT04PRaMRisaAoCqqq4vV60XUdWZax2Wy43W40TWOw4cOH85vf/IarrroKSZKIqK+v5+GHH6a3t5fhw4czf/58Vq5ciSzLPP744xQWFqIoChHnzp3jP//zP2lpacHn8/FVSaWlpToCX1d1dTWWG+ejxKej+XvQejvRA170oBetzwmhIFq/h7CnC7QwSBJydByKNRElPhElPhE5fghKnA1TTj6KbQiGxBROP3QbkhampKQEAQGBb0Fvby+7d+/mi0ydOhVJkhC4KIqiEBMTg6IoSJJERCgUwuPxEKEoChaLBa/XS0RsbCwGgwFJkojQNI3e3l7C4TBflQGBiyYroBiQzHEohij0sAqhIJqtF0JB0MLoYRVJAmQZOToayWhCMpkwDElBjo5Bjo5GjksE2YgeUEGSEBAQ+BbFxcUxdepUOjs7SU1NpaioiK1btxIfH09VVRWSJCFw0cLhMB6Phy8SDofp6+tjQG9vL5eKAYGL5nOjDMlCA6QoC7puRgeUuCRAR5JAC2vIsgRI6CYjcpQRyWBAjrYgGQ0gy+jBEIQ1NIMJQipIEgICAt8iSZJISUlB13Xq6urIyckhYurUqUiShMD3mgGBizWktYqxqX00tzSTl5dHbW0tnV1djBgxguYTJyi7/nr+uXMn48ePJyY2li2fHCbGXoB69gxK/BD0cAh/zX4so65FD/iRzNEICAh8h0iShMD3nlRaWqoj8HVVV1ezbt3f8PR6qK6upmRMCQkJCfT19fHRRx9x/Q3XI8sysiyj6zqnTp/m/+6sImFUKcYsOygGNJ8Xvd9P/O1zkCzR6H4fR8bbkSSJkpISBAQEBAQumlRaWqojICAgICBwWZMREBAQEBC47MkICAgICAhc9mQEBAQEBAQuezICAgICAgKXPRkBAQEBAYHLnoyAgICAgMBlT0ZAQEBAQOCyZ+AK0d7ezoVKS0vjYplMJn74wx8yZswY4uLikCQJVVU5ffo027Zt49SpUwgICAgIfGv+H6jg/aU1TSbnAAAAAElFTkSuQmCC" alt=""></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cc<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>SpriteFrame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> assets<span class="token operator">:</span> cc<span class="token punctuation">.</span>SpriteFrame</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame <span class="token operator">=</span> assets<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;spriteFrame.refCount : &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span>refCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="b-动态加载-bundle-目录中的资源"><a href="#b-动态加载-bundle-目录中的资源" class="header-anchor">#</a> b. 动态加载 bundle 目录中的资源</h4> <p><img src="/assets/img/220110504.af4020e0.jpg" alt=""></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span><span class="token function">loadBundle</span><span class="token punctuation">(</span><span class="token string">&quot;bundle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token operator">:</span> Error<span class="token punctuation">,</span> bundle<span class="token operator">:</span> cc<span class="token punctuation">.</span>AssetManager<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    bundle<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>SpriteFrame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> assets<span class="token operator">:</span> cc<span class="token punctuation">.</span>SpriteFrame</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame <span class="token operator">=</span> assets<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;spriteFrame.refCount : &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span>refCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><br> <p>在资源加载完成后打印下 assets 及资源的引用计数:</p> <p><img src="/assets/img/220110505.c359563d.png" alt=""></p> <p>可以看到，资源加载完成后会将 <code>SpriteFrame</code> 资源设置到 <code>Sprite</code> 组件上，但引擎不会做特殊处理，<code>SpriteFrame</code> 的引用计数仍保持 0，此时需要我们手动来管理引用计数。</p> <h3 id="_2-增加引用计数"><a href="#_2-增加引用计数" class="header-anchor">#</a> 2. 增加引用计数</h3> <p>通过 <code>addRef()</code> 方法添加引用计数:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cc<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>SpriteFrame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> assets<span class="token operator">:</span> cc<span class="token punctuation">.</span>SpriteFrame</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame <span class="token operator">=</span> assets<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span><span class="token function">addRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;spriteFrame.refCount : &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span>refCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-减少引用计数"><a href="#_3-减少引用计数" class="header-anchor">#</a> 3. 减少引用计数</h3> <p>通过 <code>decRef()</code> 方法减少引用计数:</p> <p>（为了避免过多的资源干扰视线，我们在触摸结束时减少引用计数）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">onTouchEnd</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> cc<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>EventTouch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;###&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;spriteFrame.refCount : &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame<span class="token punctuation">.</span>refCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sprite<span class="token punctuation">.</span>spriteFrame <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//在下一帧打印 assets</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <p>运行后的 log:</p> <p><img src="/assets/img/220110506.e41e134f.png" alt=""></p> <p>从 log 中可以看到，addRef 后，资源的引用计数变为 1，decRef 之后资源的引用计数在当前帧为 0，在下一帧，资源也从 assets 中被清除了。</p> <h3 id="_4-注意"><a href="#_4-注意" class="header-anchor">#</a> 4. 注意</h3> <p><code>『 动态加载 的资源必须 手动卸载 』</code>，卸载方式:</p> <ul><li>通过引用计数：<code>addRef</code>  和 <code>decRef</code></li> <li>直接释放：<code>releaseAsset</code></li></ul> <p>在资源加载完成后，会被临时缓存到 <code>cc.assetManager.assets</code> 中，以便下次复用。但是这也会造成内存和显存的持续增长，所以有些资源如果不需要用到，可以通过 <strong>自动释放</strong> 或者 <strong>手动释放</strong> 的方式进行释放。释放资源将会销毁资源的所有内部属性，比如渲染层的相关数据，并移出缓存，从而释放内存和显存（对纹理而言）。</p> <br> <h2 id="五-资源自动释放"><a href="#五-资源自动释放" class="header-anchor">#</a> 五. 资源自动释放</h2> <h3 id="_1-场景自动释放"><a href="#_1-场景自动释放" class="header-anchor">#</a> 1. 场景自动释放</h3> <p>在 资源管理器 选中场景后，属性检查器 中会出现 自动释放资源 选项 ：</p> <p><img src="/assets/img/220110507.5b32238d.jpg" alt=""></p> <p>勾选后，点击右上方的 <strong>应用</strong> 按钮，之后在切换该场景时便会自动释放该场景所有 <strong>静态引用</strong> 的依赖资源。建议场景尽量都勾选自动释放选项，以确保内存占用较低，除了部分高频使用的场景（例如主场景）。</p> <h3 id="_2-资源自动释放"><a href="#_2-资源自动释放" class="header-anchor">#</a> 2. 资源自动释放</h3> <p>所有 <code>cc.Asset</code> 实例都拥有成员函数 <code>addRef</code> 和 <code>decRef</code>，分别用于增加和减少引用计数。一旦引用计数为零，Creator 会对资源进行自动释放（需要先通过释放检查，具体可参考下部分内容的介绍）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">start</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cc<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'images/background'</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Texture2D<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> texture</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>texture <span class="token operator">=</span> texture<span class="token punctuation">;</span>
        <span class="token comment">// 当需要使用资源时，增加其引用</span>
        texture<span class="token punctuation">.</span><span class="token function">addRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">onDestroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当不需要使用资源时，减少引用</span>
    <span class="token comment">// Creator 会在调用 decRef 后尝试对其进行自动释放</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>自动释放的优势在于 <strong>不用显式地调用释放接口，开发者只需要维护好资源的引用计数，Creator 会根据引用计数自动进行释放</strong> 。这大大降低了错误释放资源的可能性，并且开发者不需要了解资源之间复杂的引用关系。对于没有特殊需求的项目，建议尽量使用自动释放的方式来释放资源。</p> <br> <h2 id="六-资源手动释放"><a href="#六-资源手动释放" class="header-anchor">#</a> 六. 资源手动释放</h2> <p>当项目中使用了更复杂的资源释放机制时，可以调用 <code>Asset Manager</code> 的相关接口来手动释放资源。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span><span class="token function">releaseAsset</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-说明："><a href="#_1-说明：" class="header-anchor">#</a> 1. 说明：</h3> <ol><li><code>cc.assetManager.releaseAsset</code> 接口仅能释放单个资源，且为了统一，接口只能通过资源本身来释放资源，不能通过资源 uuid、资源 url 等属性进行释放</li> <li>在释放资源时，开发者只需要关注资源本身，引擎会 <strong>自动释放</strong> 其依赖资源（<code>getDeps</code>）</li></ol> <h3 id="_2-注意："><a href="#_2-注意：" class="header-anchor">#</a> 2. 注意：</h3> <p><code>release</code> 系列接口（例如 <code>release</code>、<code>releaseAsset</code>、<code>releaseAll</code>）会直接释放资源，而不会进行释放检查，只有其依赖资源会进行释放检查。所以当显式调用 <code>release</code> 系列接口时，可以确保资源本身一定会被释放。</p> <br> <h2 id="七-释放检查"><a href="#七-释放检查" class="header-anchor">#</a> 七. 释放检查</h2> <p>为了避免错误释放正在使用的资源造成渲染或其他问题，Creator 会在自动释放资源之前进行一系列的检查，只有检查通过了，才会进行自动释放。</p> <ol><li><p>如果资源的引用计数为 0，即没有其他地方引用到该资源，则无需做后续检查，直接摧毁该资源，移除缓存</p></li> <li><p>资源一旦被移除，会同步触发其依赖资源的释放检查，将移除缓存后的资源的 直接 依赖资源（不包含后代）的引用都减 1，并同步触发释放检查</p></li> <li><p>如果资源的引用计数不为 0，即存在其他地方引用到该资源，此时需要进行循环引用检查，避免出现自己的后代引用自己的情况。如果循环引用检查完成之后引用计数仍不为 0，则终止释放，否则直接摧毁该资源，移除缓存，并触发其依赖资源的释放检查（同步骤 2）</p></li></ol> <br> <h2 id="八-释放过程"><a href="#八-释放过程" class="header-anchor">#</a> 八. 释放过程</h2> <p><code>releaseAsset</code> 究竟做了什么？ 查阅 assets 相关的源码:</p> <p><img src="/assets/img/220110510.c956e300.png" alt=""></p> <p>大致流程：</p> <p><img src="/assets/img/220110508.0322ec56.png" alt=""></p> <br> <p>下面是对源码的一些注释，配合流程图服用，效果更佳</p> <p><strong>手动释放:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">releaseAsset</span> <span class="token punctuation">(</span><span class="token parameter">asset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//强制释放</span>
    releaseManager<span class="token punctuation">.</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>asset<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <p><strong>减少资源的引用并尝试进行自动释放:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">decRef</span> <span class="token punctuation">(</span><span class="token parameter">autoRelease</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_ref<span class="token operator">--</span><span class="token punctuation">;</span>
    autoRelease <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> cc<span class="token punctuation">.</span>assetManager<span class="token punctuation">.</span>_releaseManager<span class="token punctuation">.</span><span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <p><strong>尝试进行释放:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">tryRelease</span> <span class="token punctuation">(</span><span class="token parameter">asset<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>asset <span class="token keyword">instanceof</span> <span class="token class-name">cc<span class="token punctuation">.</span>Asset</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//强制释放</span>
        releaseManager<span class="token punctuation">.</span><span class="token function">_free</span><span class="token punctuation">(</span>asset<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//非强制释放则添加到待删除队列</span>
        _toDelete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>_uuid<span class="token punctuation">,</span> asset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//已监听渲染过程之后所触发的事件</span>
            eventListener <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//渲染过程之后执行释放</span>
            cc<span class="token punctuation">.</span>director<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>Director<span class="token punctuation">.</span><span class="token constant">EVENT_AFTER_DRAW</span><span class="token punctuation">,</span> freeAssets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <p><strong>尝试自动去释放依赖资源并释放该资源:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">_free</span> <span class="token punctuation">(</span><span class="token parameter">asset<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从待删除队列中移除</span>
    _toDelete<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cc<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>asset<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//非强制释放则判断引用计数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asset<span class="token punctuation">.</span>refCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//检查该资源的循环引用，返回其引用计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCircularReference</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// remove from cache</span>
    assets<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取资源直接引用的非原生依赖列表，例如，材质的非原生依赖是 Texture</span>
    <span class="token keyword">var</span> depends <span class="token operator">=</span> dependUtil<span class="token punctuation">.</span><span class="token function">getDeps</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> depends<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> dependAsset <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>depends<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dependAsset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//减少资源的引用计数</span>
            dependAsset<span class="token punctuation">.</span><span class="token function">decRef</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            releaseManager<span class="token punctuation">.</span><span class="token function">_free</span><span class="token punctuation">(</span>dependAsset<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    asset<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dependUtil<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span>_uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <p><strong>释放待删除队列中的资源:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">freeAssets</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventListener <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    _toDelete<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">asset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        releaseManager<span class="token punctuation">.</span><span class="token function">_free</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _toDelete<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><br> <h2 id="九-注意点"><a href="#九-注意点" class="header-anchor">#</a> 九. 注意点</h2> <p><code>『 JavaScript 的垃圾回收是延迟的 』</code></p> <p>在 C 与 C++ 等语言中，开发人员可以直接控制内存的申请和回收，而 JavaScript 所有对象的内存都由垃圾回收机制来管理，会周期性对那些我们不再使用的变量、对象所占用的内存进行释放，这就导致 JS 层逻辑永远不知道一个对象会在什么时候被释放。</p> <p>想象一种情况，当你释放了 AssetManager 对某个资源的引用之后，由于考虑不周的原因，游戏逻辑再次请求了这个资源，这时垃圾回收还没有开始（垃圾回收的时机不可控）。</p> <p>当出现这个情况时，意味着这个资源还存在内存中，但是 AssetManager 已经访问不到了，所以会重新加载它，就会造成 <strong>这个资源在内存中有两份同样的拷贝</strong>，一份为刚刚请求的，另一份为已经释放但未被回收的，形成资源在内存中 <strong>暂时性</strong> 的 <strong>冗余</strong>。</p> <p>之所以说暂时性，是因为在下个 GC 周期时，该资源依然会被回收，释放对应的内存。</p> <p>如果只是一个资源还好，但是如果类似的资源很多，甚至不止一次被重复加载，就会造成当前时间内存飙升，而且频繁GC也会影响游戏的流畅性。</p> <p>因此我们释放资源时，应该 <code>『 避免频繁释放 』</code>，同时 <code>『 避免释放近期内将要复用的资源 』</code>。</p> <br></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/game/04性能优化/渲染性能.html" class="prev">
        关于 渲染性能优化
      </a></span> <span class="next"><a href="/game/04性能优化/drawcall.html">
        如何降低 DrawCall
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ff29e41f.js" defer></script><script src="/assets/js/3.c9686216.js" defer></script><script src="/assets/js/4.aa388247.js" defer></script>
  </body>
</html>
