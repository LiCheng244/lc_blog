<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>渲染性能优化指南 | LiCheng</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Hello, my friend!">
    <link rel="preload" href="/assets/css/0.styles.da8a643d.css" as="style"><link rel="preload" href="/assets/js/app.7bd7f7e3.js" as="script"><link rel="preload" href="/assets/js/2.4a016ca1.js" as="script"><link rel="preload" href="/assets/js/78.d7bc09f5.js" as="script"><link rel="prefetch" href="/assets/js/10.98ab9cae.js"><link rel="prefetch" href="/assets/js/100.ddf10cb3.js"><link rel="prefetch" href="/assets/js/101.66d9c095.js"><link rel="prefetch" href="/assets/js/102.93da6af8.js"><link rel="prefetch" href="/assets/js/103.00735b7f.js"><link rel="prefetch" href="/assets/js/104.31be4b4d.js"><link rel="prefetch" href="/assets/js/105.7b457f7f.js"><link rel="prefetch" href="/assets/js/106.52dca4d1.js"><link rel="prefetch" href="/assets/js/107.67363668.js"><link rel="prefetch" href="/assets/js/108.2db92c78.js"><link rel="prefetch" href="/assets/js/109.512d16fd.js"><link rel="prefetch" href="/assets/js/11.9cfd3f7b.js"><link rel="prefetch" href="/assets/js/110.886c7cb9.js"><link rel="prefetch" href="/assets/js/111.1fb98a63.js"><link rel="prefetch" href="/assets/js/112.ffdeb53b.js"><link rel="prefetch" href="/assets/js/113.0ee4c6c0.js"><link rel="prefetch" href="/assets/js/114.d73d9b8f.js"><link rel="prefetch" href="/assets/js/115.37324632.js"><link rel="prefetch" href="/assets/js/116.88188962.js"><link rel="prefetch" href="/assets/js/117.fd567eda.js"><link rel="prefetch" href="/assets/js/118.96ecc85c.js"><link rel="prefetch" href="/assets/js/119.1276e653.js"><link rel="prefetch" href="/assets/js/12.01a7f8e0.js"><link rel="prefetch" href="/assets/js/120.df5ea5cc.js"><link rel="prefetch" href="/assets/js/121.507a83a2.js"><link rel="prefetch" href="/assets/js/122.b3397198.js"><link rel="prefetch" href="/assets/js/123.7c438b23.js"><link rel="prefetch" href="/assets/js/124.d06847d7.js"><link rel="prefetch" href="/assets/js/125.44243c3c.js"><link rel="prefetch" href="/assets/js/126.20775319.js"><link rel="prefetch" href="/assets/js/127.13253803.js"><link rel="prefetch" href="/assets/js/128.24cc32c3.js"><link rel="prefetch" href="/assets/js/129.c159ac3b.js"><link rel="prefetch" href="/assets/js/13.d7ddf41a.js"><link rel="prefetch" href="/assets/js/130.e06e598b.js"><link rel="prefetch" href="/assets/js/131.648de130.js"><link rel="prefetch" href="/assets/js/132.d8536c50.js"><link rel="prefetch" href="/assets/js/133.ee365ef8.js"><link rel="prefetch" href="/assets/js/134.bb0c4f34.js"><link rel="prefetch" href="/assets/js/135.a2f7931b.js"><link rel="prefetch" href="/assets/js/136.61f27767.js"><link rel="prefetch" href="/assets/js/137.54ed18c6.js"><link rel="prefetch" href="/assets/js/138.4c526725.js"><link rel="prefetch" href="/assets/js/139.03d58b40.js"><link rel="prefetch" href="/assets/js/14.446ca648.js"><link rel="prefetch" href="/assets/js/140.9caf5c8f.js"><link rel="prefetch" href="/assets/js/141.0729449d.js"><link rel="prefetch" href="/assets/js/142.f9cfee48.js"><link rel="prefetch" href="/assets/js/143.5d64db80.js"><link rel="prefetch" href="/assets/js/144.a816ebb2.js"><link rel="prefetch" href="/assets/js/145.5d09a318.js"><link rel="prefetch" href="/assets/js/146.376b91f9.js"><link rel="prefetch" href="/assets/js/147.48e835bb.js"><link rel="prefetch" href="/assets/js/148.ff3a0f46.js"><link rel="prefetch" href="/assets/js/149.43425d5d.js"><link rel="prefetch" href="/assets/js/15.f055d7f7.js"><link rel="prefetch" href="/assets/js/150.99a891d1.js"><link rel="prefetch" href="/assets/js/151.3ddd2f6b.js"><link rel="prefetch" href="/assets/js/152.2067613a.js"><link rel="prefetch" href="/assets/js/153.a5edab80.js"><link rel="prefetch" href="/assets/js/154.72d5d638.js"><link rel="prefetch" href="/assets/js/155.14186e52.js"><link rel="prefetch" href="/assets/js/156.89707510.js"><link rel="prefetch" href="/assets/js/157.ff59020d.js"><link rel="prefetch" href="/assets/js/158.f99ac0a1.js"><link rel="prefetch" href="/assets/js/159.07dd23df.js"><link rel="prefetch" href="/assets/js/16.a2d753f3.js"><link rel="prefetch" href="/assets/js/160.85551311.js"><link rel="prefetch" href="/assets/js/161.a97cbe97.js"><link rel="prefetch" href="/assets/js/162.11fed502.js"><link rel="prefetch" href="/assets/js/163.169ac188.js"><link rel="prefetch" href="/assets/js/164.e6bef9e3.js"><link rel="prefetch" href="/assets/js/165.a63546e5.js"><link rel="prefetch" href="/assets/js/166.329c5fe4.js"><link rel="prefetch" href="/assets/js/167.213d359e.js"><link rel="prefetch" href="/assets/js/168.387346ac.js"><link rel="prefetch" href="/assets/js/169.3da0651d.js"><link rel="prefetch" href="/assets/js/17.b9dd3a30.js"><link rel="prefetch" href="/assets/js/170.f1f45ff3.js"><link rel="prefetch" href="/assets/js/171.03b44e8a.js"><link rel="prefetch" href="/assets/js/172.ef943c4a.js"><link rel="prefetch" href="/assets/js/18.9de80c7d.js"><link rel="prefetch" href="/assets/js/19.6f233c58.js"><link rel="prefetch" href="/assets/js/20.3b1720d8.js"><link rel="prefetch" href="/assets/js/21.a60d0d35.js"><link rel="prefetch" href="/assets/js/22.9969fd7b.js"><link rel="prefetch" href="/assets/js/23.a09b7522.js"><link rel="prefetch" href="/assets/js/24.063a9b16.js"><link rel="prefetch" href="/assets/js/25.2449a782.js"><link rel="prefetch" href="/assets/js/26.ab749819.js"><link rel="prefetch" href="/assets/js/27.9c10fc5c.js"><link rel="prefetch" href="/assets/js/28.30ec38b9.js"><link rel="prefetch" href="/assets/js/29.e9ca5ab4.js"><link rel="prefetch" href="/assets/js/3.edd5597f.js"><link rel="prefetch" href="/assets/js/30.755bd25e.js"><link rel="prefetch" href="/assets/js/31.b8850454.js"><link rel="prefetch" href="/assets/js/32.8afdad1b.js"><link rel="prefetch" href="/assets/js/33.50c69a83.js"><link rel="prefetch" href="/assets/js/34.be4722b7.js"><link rel="prefetch" href="/assets/js/35.027469a0.js"><link rel="prefetch" href="/assets/js/36.508e2d05.js"><link rel="prefetch" href="/assets/js/37.5293a854.js"><link rel="prefetch" href="/assets/js/38.82444bae.js"><link rel="prefetch" href="/assets/js/39.87ffdf6a.js"><link rel="prefetch" href="/assets/js/4.b0f9acc9.js"><link rel="prefetch" href="/assets/js/40.cd79d900.js"><link rel="prefetch" href="/assets/js/41.bb432320.js"><link rel="prefetch" href="/assets/js/42.5a1c8f3f.js"><link rel="prefetch" href="/assets/js/43.f7260336.js"><link rel="prefetch" href="/assets/js/44.24e9aeec.js"><link rel="prefetch" href="/assets/js/45.27f89e1f.js"><link rel="prefetch" href="/assets/js/46.81263b84.js"><link rel="prefetch" href="/assets/js/47.91a4ea50.js"><link rel="prefetch" href="/assets/js/48.f4f51932.js"><link rel="prefetch" href="/assets/js/49.3b5d7d2b.js"><link rel="prefetch" href="/assets/js/5.02d4e4d0.js"><link rel="prefetch" href="/assets/js/50.0b3024cd.js"><link rel="prefetch" href="/assets/js/51.b172c491.js"><link rel="prefetch" href="/assets/js/52.8bd2d65e.js"><link rel="prefetch" href="/assets/js/53.eddce191.js"><link rel="prefetch" href="/assets/js/54.b6aa6a94.js"><link rel="prefetch" href="/assets/js/55.e7fac909.js"><link rel="prefetch" href="/assets/js/56.1220b20c.js"><link rel="prefetch" href="/assets/js/57.bfff6177.js"><link rel="prefetch" href="/assets/js/58.2770ed43.js"><link rel="prefetch" href="/assets/js/59.eca63a69.js"><link rel="prefetch" href="/assets/js/6.de79aaae.js"><link rel="prefetch" href="/assets/js/60.4cbbe300.js"><link rel="prefetch" href="/assets/js/61.cebddfec.js"><link rel="prefetch" href="/assets/js/62.cc0e4ab1.js"><link rel="prefetch" href="/assets/js/63.51555ab8.js"><link rel="prefetch" href="/assets/js/64.9e4bd900.js"><link rel="prefetch" href="/assets/js/65.5b59983a.js"><link rel="prefetch" href="/assets/js/66.86d38248.js"><link rel="prefetch" href="/assets/js/67.5b7fbb1e.js"><link rel="prefetch" href="/assets/js/68.bec1fca3.js"><link rel="prefetch" href="/assets/js/69.7cbd17ad.js"><link rel="prefetch" href="/assets/js/7.598ffbd3.js"><link rel="prefetch" href="/assets/js/70.368dccff.js"><link rel="prefetch" href="/assets/js/71.03e3bc4e.js"><link rel="prefetch" href="/assets/js/72.e1606491.js"><link rel="prefetch" href="/assets/js/73.d2a5b30b.js"><link rel="prefetch" href="/assets/js/74.04db2d95.js"><link rel="prefetch" href="/assets/js/75.5dfc5d16.js"><link rel="prefetch" href="/assets/js/76.5e87c404.js"><link rel="prefetch" href="/assets/js/77.1a8f9dfc.js"><link rel="prefetch" href="/assets/js/79.c408841b.js"><link rel="prefetch" href="/assets/js/8.cb3c422c.js"><link rel="prefetch" href="/assets/js/80.a851c494.js"><link rel="prefetch" href="/assets/js/81.e90a5f17.js"><link rel="prefetch" href="/assets/js/82.11515b9e.js"><link rel="prefetch" href="/assets/js/83.d6e4dc83.js"><link rel="prefetch" href="/assets/js/84.04356605.js"><link rel="prefetch" href="/assets/js/85.3fadd51a.js"><link rel="prefetch" href="/assets/js/86.ceb3f5a2.js"><link rel="prefetch" href="/assets/js/87.600d2510.js"><link rel="prefetch" href="/assets/js/88.d422f37c.js"><link rel="prefetch" href="/assets/js/89.cd6f4925.js"><link rel="prefetch" href="/assets/js/9.6ab9c9fd.js"><link rel="prefetch" href="/assets/js/90.033455fd.js"><link rel="prefetch" href="/assets/js/91.af121b20.js"><link rel="prefetch" href="/assets/js/92.e3735c50.js"><link rel="prefetch" href="/assets/js/93.ff0e7eec.js"><link rel="prefetch" href="/assets/js/94.4e6cade9.js"><link rel="prefetch" href="/assets/js/95.89460589.js"><link rel="prefetch" href="/assets/js/96.fa68eb6d.js"><link rel="prefetch" href="/assets/js/97.8efe4704.js"><link rel="prefetch" href="/assets/js/98.f1e773aa.js"><link rel="prefetch" href="/assets/js/99.c32b1a51.js">
    <link rel="stylesheet" href="/assets/css/0.styles.da8a643d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="LiCheng" class="logo"> <span class="site-name can-hide">LiCheng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/game/00基础知识/" class="sidebar-heading clickable"><span>基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/01JavaScript/" class="sidebar-heading clickable"><span>JavaScript</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/game/02TypeScript/" class="sidebar-link">TypeScript</a></li><li><a href="/game/03%E5%BE%AE%E4%BF%A1%E5%B0%8F%E6%B8%B8%E6%88%8F/" class="sidebar-link">微信小游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/04性能优化/" class="sidebar-heading clickable open"><span>性能优化</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/game/04性能优化/性能指标.html" class="sidebar-link">关于性能优化指标</a></li><li><a href="/game/04性能优化/帧率性能优化.html" class="active sidebar-link">渲染性能优化指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#一-什么是渲染性能？" class="sidebar-link">一. 什么是渲染性能？</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#二-opengl-webgl-绘制命令" class="sidebar-link">二. OpenGL/WebGL 绘制命令</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#三-drawcalls" class="sidebar-link">三. DrawCalls</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#四-批处理（合批）" class="sidebar-link">四. 批处理（合批）</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#五-creator合图的几种方式" class="sidebar-link">五. Creator合图的几种方式</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#六-文本框的处理" class="sidebar-link">六. 文本框的处理</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#七-层级管理以及粒子，spine，cc-graphics" class="sidebar-link">七. 层级管理以及粒子，Spine，cc.Graphics</a></li><li class="sidebar-sub-header"><a href="/game/04性能优化/帧率性能优化.html#八-压缩纹理" class="sidebar-link">八. 压缩纹理</a></li></ul></li><li><a href="/game/04性能优化/TexturePacker.html" class="sidebar-link">TexturePacker黑边问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/05Creator/" class="sidebar-heading clickable"><span>Creator</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1>渲染性能优化指南</h1> <div class="custom-block tip"><p class="custom-block-title">前言</p> <p>本篇介绍在 CocosCreator 环境下，对游戏程序渲染性能方面各种手段的考察。</p></div> <br> <h2 id="一-什么是渲染性能？"><a href="#一-什么是渲染性能？" class="header-anchor">#</a> 一. 什么是渲染性能？</h2> <h3 id="_1-帧率"><a href="#_1-帧率" class="header-anchor">#</a> 1.帧率:</h3> <p>是用户对程序的流畅程度比较直观的感受——如果游戏长时间处于一个低于设计帧率的状态，用户就会觉得“卡”。
从开发者的角度看，帧率降低，是缘于程序的各种运算和操作消耗了过大的系统资源，导致程序必须花费超过“预想的一帧时间”去完成它的工作。
所以一般来说，帧率不符合预期往往同时还伴随着设备发热，设备耗电加剧，设备内存占用过高导致崩溃等负面情况。</p> <p>在一些应用场景中，<strong>游戏的帧率往往不仅受到绘制操作的影响。</strong> 其他方面的计算消耗，或者过大的内存占用，都会和帧率产生相互影响。</p> <h3 id="_2-影响性能的情况"><a href="#_2-影响性能的情况" class="header-anchor">#</a> 2.影响性能的情况:</h3> <p>以下是cocos游戏程序应用场景中，可能对整体性能有负面影响的情况：</p> <ul><li><strong>图形绘制部分造成了过大的开销</strong> （比如最常见的就是Drawcalls 过高)；</li> <li><strong>非绘制部分的计算工作过于繁重</strong> （比如每帧都会进行的大型for循环，数值计算，以碰撞检测和过于繁重的物理引擎计算最为常见）；</li> <li><strong>过高的内存占用和帧率的相互影响</strong>：</li></ul> <ol><li>在浏览器环境下（h5，也包括微信小游戏），系统的内存回收是在程序的空闲时间见缝插针地执行。而过高的系统开销会导致内存收回找不到这样的空闲时间——也就是说，帧率降低的同时可能还存在内存垃圾无法回收的情况；</li></ol> <p>2） 因为自动垃圾回收机制的存在，过高的内存占用必然会导致内存回收耗费更长的时间。这个时间开销，也会反过来影响帧率。</p> <div class="custom-block warning"><p class="custom-block-title">图形绘制</p> <p>“渲染性能”这个概念，其实还包含其他诸多方面。但接下来的内容将只局限于其中的一个范畴，即，<strong>图形绘制对游戏程序帧率的影响</strong> 。也就是说，只讨论上述情况中的第一种。</p></div> <br> <h2 id="二-opengl-webgl-绘制命令"><a href="#二-opengl-webgl-绘制命令" class="header-anchor">#</a> 二. OpenGL/WebGL 绘制命令</h2> <p><strong>我们目前的、以及将来较长一段时间的游戏项目，都将会采用<a href="../00%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/OpenGL" title="OpenGL或WebGL（简介）">OpenGL或WebGL</a>的渲染方式。</strong></p> <p>在代码层面，我们要完成一帧游戏画面的绘制，需要调用一系列的 <strong>GL绘制命令</strong> ，其基本操作如下：</p> <h3 id="_1-清屏"><a href="#_1-清屏" class="header-anchor">#</a> 1. 清屏</h3> <p>将上一帧绘制的内容清空，一般如下：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.2f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接着，按照层级关系，依次对显示元素进行接下来的2,3,4,5步骤：</p> <h3 id="_2-绑定纹理数据"><a href="#_2-绑定纹理数据" class="header-anchor">#</a> 2. 绑定纹理数据</h3> <p>首先是绑定纹理数据（亦称之为贴图，图片素材）：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> texture1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-顶点数据"><a href="#_3-顶点数据" class="header-anchor">#</a> 3. 顶点数据</h3> <p>然后准备好顶点数据（包括顶点位置，索引，颜色），并绑定，比如：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>    <span class="token keyword">float</span> vertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// positions          // colors           // texture coords</span>
         <span class="token number">0.5f</span><span class="token punctuation">,</span>  <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>   <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>   <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> indices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// first triangle</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token comment">// second triangle</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> VBO<span class="token punctuation">,</span> EBO<span class="token punctuation">;</span>

    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> VBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="token punctuation">,</span> EBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ELEMENT_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">,</span> indices<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// position attribute</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// color attribute</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// texture coord attribute</span>
    <span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-shader的加载"><a href="#_4-shader的加载" class="header-anchor">#</a> 4. shader的加载</h3> <p>shader的加载，编译，使用：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//加载</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// vertex shader 编译</span>
vertex <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_VERTEX_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glShaderSource</span><span class="token punctuation">(</span>vertex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vShaderCode<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glCompileShader</span><span class="token punctuation">(</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fragment Shader编译</span>
fragment <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_FRAGMENT_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glShaderSource</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fShaderCode<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glCompileShader</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建shader实例，并绑定</span>
ProgramID <span class="token operator">=</span> <span class="token function">glCreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glAttachShader</span><span class="token punctuation">(</span>ID<span class="token punctuation">,</span> vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glAttachShader</span><span class="token punctuation">(</span>ID<span class="token punctuation">,</span> fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glLinkProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//赋值</span>
<span class="token function">glUniform1i</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用</span>
<span class="token function">glUseProgram</span><span class="token punctuation">(</span>ProgramID<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-绘制顶点命令"><a href="#_5-绘制顶点命令" class="header-anchor">#</a> 5. 绘制顶点命令</h3> <p>准备工作就绪，调用<strong>绘制顶点命令</strong>：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">glDrawElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或者</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-完成渲染"><a href="#_6-完成渲染" class="header-anchor">#</a> 6. 完成渲染</h3> <p>对所有显示元素均进行步骤2，3，4，5，直到遍历完整个渲染列表。</p> <br> <p><strong>去掉详细代码的部分，绘制步骤精简为：</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li>清屏。按层级关系依次对显示元素进行2,3,4,5步；</li> <li>绑定纹理数据（亦称之为贴图，图片素材）；</li> <li>准备顶点数据（包括顶点位置，索引，颜色），并绑定；</li> <li>编译使用shader；</li> <li>调用 <strong>绘制顶点命令</strong> <code>glDrawElements()</code>：</li> <li>对所有显示元素均进行步骤2，3，4，5。直到遍历完整个渲染列表。</li></ol></div> <p>以上即为我们的游戏程序调用OpenGL API去完成图形绘制的过程。 这个过程导致的系统开销，根本上决定了程序的渲染性能。而对这个过程的优化处理，即是对渲染性能的优化。</p> <br> <h2 id="三-drawcalls"><a href="#三-drawcalls" class="header-anchor">#</a> 三. DrawCalls</h2> <h3 id="_1-什么是drawcalls"><a href="#_1-什么是drawcalls" class="header-anchor">#</a> 1. 什么是DrawCalls?</h3> <p><code>Drawcall</code> ，这个词可以从中文翻译的字面意思去理解：Draw Call——绘制调用。</p> <p>从OpenGL/WebGL的API层面去看，可以狭义地和“对<code>glDrawElements()</code>或<code>glDrawArrays()</code>的调用”划等号。</p> <p>实际上CocosCreator引擎的Drawcalls计数，就是对<code>glDrawElements()</code>调用的计数，也就是上面讲述的 <strong>绘制步骤的第5步</strong> 的执行计数。</p> <p>故而，我们常说的“降低DrawCalls”，其实就是降低<code>glDrawElements()</code>的执行次数。</p> <h3 id="_2-为什么要减少drawcalls"><a href="#_2-为什么要减少drawcalls" class="header-anchor">#</a> 2. 为什么要减少DrawCalls?</h3> <p>那么为什么通常减少了DrawCalls，渲染性能就能有所提升？ 或者说，为什么减少<code>glDrawElements()</code>的执行次数是有效的性能优化手段？</p> <p>通过观察上面提到的GL绘制6大步骤，我们了解到：每次在我们调用<code>glDrawElements()</code>命令之前，都必须先进行 <strong>绑纹理-绑顶点-使用shader</strong> 这3项准备工作，唯有这样才能保证图形如我们预期地绘制出来。</p> <p>在某一帧的绘制中，<code>glDrawElements()</code>执行次数变多，必然关系到前3项准备工作的次数也增多。事实上3项准备工作和<code>glDrawElements()</code>联合起来，同时对系统开销造成影响。</p> <p>所以降低drawCalls的意义，不仅在于减少<code>glDrawElements()</code>本身，也意味着让 <strong>绑纹理-绑顶点-使用shader</strong> 步骤中所包含的诸多命令调用频次的减少。</p> <h3 id="_3-是不是只要drawcalls减少了，帧率就一定会更稳定"><a href="#_3-是不是只要drawcalls减少了，帧率就一定会更稳定" class="header-anchor">#</a> 3. 是不是只要DrawCalls减少了，帧率就一定会更稳定?</h3> <p>从以上分析，我们知道减少DrawCalls其实是为了减少<strong>绑纹理-绑顶点-使用shader-绘制顶点</strong>这几个命令的调用。但如果这几个操作本身就有很高的系统开销，此时即便drawCalls很低，也一样得不到好的渲染表现。</p> <p>下面是一些常见的除drawcalls之外导致帧率下降的因素:</p> <h4 id="a-绘制过多的顶点"><a href="#a-绘制过多的顶点" class="header-anchor">#</a> A. 绘制过多的顶点:</h4> <p>这种情况在3D游戏中更普遍——为了更细致的表现效果，3D模型的顶点数往往会非常多。 而<strong>2D游戏在大部分情况下，一个Sprite只有4个顶点</strong> ，需要绘制的顶点数量通常比3D游戏更可控。</p> <p>当然也有一些细节要注意：<strong>九宫（SLICED）拉伸模式会让<code>Sprite</code>的顶点数变成16个，TILED拉伸模式会让顶点数量不固定的变多，这取决于Sprite尺寸和原始图片尺寸的比例。还有文本框，如果文本框是用单个文字的纹理拼接的，那么一段内容比较大的文本框也会让顶点数暴增。</strong></p> <h4 id="b-用了算法复杂的-shader"><a href="#b-用了算法复杂的-shader" class="header-anchor">#</a> B. 用了算法复杂的 Shader:</h4> <p>比如在片元着色器中进行大型for循环和数值计算，这是非常考验设备性能的操作，表现效果在不同终端上往往会有非常大的差别。</p> <p>这里还要提到顶点着色器和片元着色器的区别：</p> <p>顶点着色器是对顶点进行逐一操作，而片元着色器是对光栅化后的像素进行逐一操作——通常情况下像素的数量是远多于顶点的。 比如对颜色进行相同的处理，（因为顶点的数量比像素少）用顶点着色器去完成会比片元着色器效率高得多，当然片元着色器能给出更好的表现效果（因为精确到像素）。这些问题是需要设计者权衡的。当然很多特效只能通过片元着色器才能完成，常见的比如Sprite模糊，Sprite描边。）</p> <h4 id="c-绑定更多的纹理"><a href="#c-绑定更多的纹理" class="header-anchor">#</a> C. 绑定更多的纹理:</h4> <p>有一些特殊效果会需要我们绑定多个纹理给GPU，在 shader 中同时处理多个纹理数据。</p> <p>OPENGL/WEBGL 默认可以同时在GPU绑定32个纹理数据，微信小游戏也支持同时绑定8个纹理数据。绑定和处理更多的纹理也会造成更多的系统开销。</p> <br> <h2 id="四-批处理（合批）"><a href="#四-批处理（合批）" class="header-anchor">#</a> 四. 批处理（合批）</h2> <p>众所周知，在电脑硬盘上进行文件移动操作，对于单独一个1G的文件 和 1024个1M的文件，前者通常会比后者更快完成。OpenGL渲染批处理的概念，可以考虑成与之类似的一种处理。</p> <h3 id="_1-什么是批处理？"><a href="#_1-什么是批处理？" class="header-anchor">#</a> 1. 什么是批处理？</h3> <p>设想下面两种情况：</p> <h4 id="a-一帧中，执行1000次以下步骤："><a href="#a-一帧中，执行1000次以下步骤：" class="header-anchor">#</a> A.一帧中，执行1000次以下步骤：</h4> <ol><li><strong>创建一个四边形的6个顶点（两个三角形），索引，颜色，并绑定；</strong></li> <li>绑定纹理；</li> <li>使用shader；</li> <li>glDrawElements()；</li></ol> <h4 id="b-一帧中，执行1次以下步骤："><a href="#b-一帧中，执行1次以下步骤：" class="header-anchor">#</a> B.一帧中，执行1次以下步骤：</h4> <ol><li><strong>创建一个1000个四边形的6000个顶点，索引，颜色，并绑定；</strong></li> <li>绑定纹理；</li> <li>使用shader；</li> <li>glDrawElements()；</li></ol> <p>两种做法最终都在一帧中完成了1000个四边形，6000个顶点的绘制。但B方法的2，3，4步仅仅只执行了一次，而A的2，3，4各执行了1000次。</p> <p><strong>其实B方法，就是我们所谓的“批处理”——把多个顶点放在“同一批”去绘制。</strong></p> <h3 id="_2-图集为什么能做到批处理？"><a href="#_2-图集为什么能做到批处理？" class="header-anchor">#</a> 2. 图集为什么能做到批处理？</h3> <p>通过上面的分析，我们知道，要让多个绘制合并到一个Drawcall, 要满足以下几个前提条件：</p> <ol><li>多个顶点同时绑定；</li> <li>这批顶点使用同一个（或同一组）纹理数据；</li> <li>这批顶点使用相同的shader及其他相同的绘制参数。</li></ol> <p>考虑条件2，我们要<strong>保证绘制列表里的元素都使用同一份纹理数据</strong> ，而图集就是让我们达到这一点的手段。</p> <p><strong>那怎么让不同内容的Sprite使用图集上的不同部分呢？</strong></p> <p>我们准备提交给GL的顶点数据中，不仅包括每个顶点的位置，索引，颜色，同时也会将一个“UV坐标”提交给GL，它指某个顶点在纹理中对应的像素位置。引擎会在shader中根据UV坐标，来确定渲染出来的像素对应图集中的哪一部分。</p> <p>比如cocosCreator的默认shader，builtin-2d-sprite.effect：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>  <span class="token keyword">void</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vec4 o <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TEXTURE</span></span>
    o <span class="token operator">*=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_uv0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//根据UV坐标确定像素值</span>
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CC_USE_ALPHA_ATLAS_TEXTURE</span></span>
      o<span class="token punctuation">.</span>a <span class="token operator">*=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_uv0 <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span>
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    o <span class="token operator">*=</span> v_color<span class="token punctuation">;</span>
 
    <span class="token function">ALPHA_TEST</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    gl_FragColor <span class="token operator">=</span> o<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>因为UV坐标是和其他顶点信息一起提交的，它只在每次绑定时被改变（被赋值），所以虽然渲染不同Sprite使用了不同的UV值，但不会造成drawCalls的增加。 合图就是用这种方式实现了不同内容的多个Sprite合批。</p> <p>由此可知，我们对顶点分别设置不同的颜色，也不会造成drawCalls增加。比如在合批的前提下，进行 <code>nodeA.color = cc.Color(&quot;#ff0000&quot;)</code>这样的操作是不会导致drawCalls增加的。因为colorCreator引擎将色值作为顶点数据一起绑定。</p> <h3 id="_3-什么情况会打断合批？"><a href="#_3-什么情况会打断合批？" class="header-anchor">#</a> 3. 什么情况会打断合批？</h3> <p>我们已经知道如何利用图集实现批处理，但仅仅采用图集并不能保证多个视图元素drawCalls次数为1。OPENGL的绘制有几个步骤，但凡其中任一步骤发生变化，都会“打断合批”，导致drawCalls次数增加。</p> <p><strong>下面是一些常见的必定会打断合批的应用场景：</strong></p> <ul><li>Sprite 使用了不同的贴图文件（散图）；</li> <li>用了 cc.Mask 遮罩（使用了不同的模板测试策略）；</li> <li>多个 Sprite 运用了不同的混合模式 cc.Blend ；</li> <li>多个 Sprite 运用了不同的 shader ；</li> <li>多个 Sprite 运用了相同的 shader, 但使用了不同的 uniform 值；</li> <li>渲染队列中有文本框“插队”，而这个文本框中的字符贴图并没有使用图集中的素材；</li></ul> <p><strong>下面的这些改变不会打断合批（在已经保证合批的前提下）：</strong></p> <ul><li>node.color, node.opacity的变化；</li> <li>纹理拉伸策略的不同，SIMLE, SLICED, TILED；</li> <li>Sprite SizeMode的不同，CUSTOM，TRIMMED；</li> <li>顶点动画（简单的比如位移，scale,skew,rotate, 或者一些复杂的顶点动画效果，比如Spine的FFD(挤压，弯曲，变形)) ；</li></ul> <br> <h2 id="五-creator合图的几种方式"><a href="#五-creator合图的几种方式" class="header-anchor">#</a> 五. Creator合图的几种方式</h2> <p>合图策略大致分为两种：静态合图和动态合图。</p> <p><strong>静态合图：</strong>
将散图拼接为图集文件。程序进行时加载图集文件的数据。图集是在程序启动前就已经准备好的。</p> <p><strong>动态合图：</strong>
不需要预先生成图集文件，程序资源包里只有散图。程序进行渲染的同时将已经渲染的内容进行拼接并缓存，下次再绘制相同内容时，多个sprite共同使用已经拼接过的缓存。</p> <p>动态合图的优势在于：</p> <ol><li>可以将一些很难加入静态图集的内容也加入批处理（比如动态改变的汉字，静态合图无法做到包含所有汉字）；</li> <li>随时选择哪些素材是真正需要绑定到GPU的（比如战斗场景中只需要战斗相关的资源）。 当然，随之而来的内存管理工作也会更加复杂，对于一些短暂出现的内容（比如一个战斗场景中的汉字，特效。战斗结束之后就用不到了）要做到及时回收，以防内存泄漏。</li></ol> <p>一个对性能要求很高的2D游戏项目，往往需要静态合图和动态合图两者配合，才能达到最大程度的性能优化。</p> <h3 id="_1-textruepacker"><a href="#_1-textruepacker" class="header-anchor">#</a> 1. TextruePacker</h3> <p><a href="https://www.codeandweb.com/texturepacker" title="官网" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>老牌商业合图工具。进行静态合图的生成。可惜是收费软件，并且按年付费。</p> <p><strong>优点：</strong></p> <p>图集在开发环境下已经生成好，可以在开发环境就能看出合批的实际效果。也能预先了解图集的尺寸，占用空间等信息。</p> <p><strong>缺点：</strong></p> <ol><li><s>打出的合图再在某些情况下会有Sprite黑边问题。</s> <a href="client_guide-1c2kcar5ccbmo" title="TexturePacker 黑边问题解决">已有解决方案，只是需要修改Sprite的默认混合模式</a>。</li> <li>要花钱。</li></ol> <h3 id="_2-creator-ide合图功能"><a href="#_2-creator-ide合图功能" class="header-anchor">#</a> 2. Creator IDE合图功能</h3> <p><a href="https://docs.cocos.com/creator/manual/zh/asset-workflow/auto-atlas.html" title="cocos官方介绍" target="_blank" rel="noopener noreferrer">cocos官方介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>静态合图。在build时，将一个资源目录下的散图合并为图集。可以避免TextruePacker的黑边问题。</p> <p><strong>优点：</strong></p> <p>IDE内解决问题，避免TextruePacker的黑边问题。</p> <p><strong>缺点：</strong></p> <p>build才会生成合图，所以开发环境下还是用散图渲染，不能直观看到实际drawCalls情况。对于图片超出尺寸限制等问题无法预先判断。</p> <h3 id="_3-creator-2-1-后的动态合图"><a href="#_3-creator-2-1-后的动态合图" class="header-anchor">#</a> 3. Creator 2.1 后的动态合图</h3> <p><a href="https://docs.cocos.com/creator/manual/zh/advanced-topics/dynamic-atlas.html" title="cocos官方介绍" target="_blank" rel="noopener noreferrer">cocos官方介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>虽然上文提到动态合图是对合批进行精确控制的手段。 但是到现在版本为止（creator2.3.3)，creator的动态合图恰恰没有精确控制的功能。它只是将所有低于某个尺寸限制的纹理都自动合并，并不给开发者提供诸如“这张散图不需要合批”，“区分动态图集A，动态图集B”，“清理动态图集A，保留动态图集B”这样的功能。 还有一个大问题是，动态合图还没有提供原生方面的支持，也就是它只在web环境下有效。 要完善上面的这些问题，开发者需要等待后续的版本，或者自己动手对引擎做一系列修改。总之，CocosCreator目前的动态合图，还是一个比较粗糙的东西，只适用试验或者一些图片资源非常有限，复杂度很低的项目。</p> <p><strong>注:</strong></p> <p>cocosCreator 2.1 后，引擎默认开启自动合图，想要单纯采取静态合图策略，需要关闭自动合图开关<code>cc.dynamicAtlasManager.enabled = false;</code>。</p> <h3 id="_4-方式比较"><a href="#_4-方式比较" class="header-anchor">#</a> 4. 方式比较</h3> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">TexturePacker</th> <th style="text-align:center;">Creator自动图集</th> <th style="text-align:center;">Creator动态合图</th></tr></thead> <tbody><tr><td style="text-align:center;">免费</td> <td style="text-align:center;">NO</td> <td style="text-align:center;">YES</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">黑边问题</td> <td style="text-align:center;">YES</td> <td style="text-align:center;">NO</td> <td style="text-align:center;">NO</td></tr> <tr><td style="text-align:center;">合批效果即时预览</td> <td style="text-align:center;">YES</td> <td style="text-align:center;">NO</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">精确控制</td> <td style="text-align:center;">YES</td> <td style="text-align:center;">YES</td> <td style="text-align:center;">NO</td></tr> <tr><td style="text-align:center;">兼容动态文字</td> <td style="text-align:center;">NO</td> <td style="text-align:center;">NO</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">浏览器版本</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;">原生版本</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">不支持</td></tr></tbody></table> <br> <h2 id="六-文本框的处理"><a href="#六-文本框的处理" class="header-anchor">#</a> 六. 文本框的处理</h2> <h3 id="_1-艺术字体文本框"><a href="#_1-艺术字体文本框" class="header-anchor">#</a> 1.艺术字体文本框</h3> <p><strong>对于不会有变化的汉字:</strong> 英文艺术字文本（比如按钮上的“确定”艺术文本），合理的做法是将整个文本框内容置于图集；</p> <p><strong>对于经常变化的:</strong> 英文&amp;数字的艺术字文本（比如计分文本框），我们以前的做法往往是将其用BmpFont做成艺术字导入到项目，然后绑定到cc.Label。
但是BmpFont的纹理必然独立于全局的静态图集之外，这就造成了DrawCalls的增加。
为了优化DrawCalls，更好的做法是将这些艺术字贴图合并到全局静态图集，显示上用cc.Layout（自动排列容器）和cc.Sprite代替cc.Label（这个做法在 《头号枪手》，《最强消方块》，《快来消星星》中已经实践）。</p> <h3 id="_2-非艺术字体文本框"><a href="#_2-非艺术字体文本框" class="header-anchor">#</a> 2. 非艺术字体文本框</h3> <p>cocosCreator 2.x 后， 引擎对非位图字体的cc.Label渲染方式有了更精确的划分，以此来解决文本框在不同应用场景下的效率问题。这就是 cc.Label 的 CacheMode 。</p> <p>详见，<a href="http://docs.cocos.com/creator/manual/zh/components/label.html" title="cc.Label" target="_blank" rel="noopener noreferrer">cc.Label组件参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
及<a href="http://docs.cocos.com/creator/manual/zh/advanced-topics/ui-auto-batch.html" target="_blank" rel="noopener noreferrer">UI 渲染批次合并指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <br> <h2 id="七-层级管理以及粒子，spine，cc-graphics"><a href="#七-层级管理以及粒子，spine，cc-graphics" class="header-anchor">#</a> 七. 层级管理以及粒子，Spine，cc.Graphics</h2> <h3 id="_1-层级管理"><a href="#_1-层级管理" class="header-anchor">#</a> 1. 层级管理</h3> <p>为了最大化发挥合批的优势，层级管理也是不得不考虑的一个问题。</p> <p>为了保证绘制结果的正确性，提交给GL的顶点数据的组织，一般都会按照显示元素的层级依次添加。所以，让能够参与合批的视图元素在层级上尽量挨在一起，就能保证drawCalls尽量小。按照这个思路，我们可以考虑以下手段来进行层级优化：</p> <h4 id="a-外部跟随"><a href="#a-外部跟随" class="header-anchor">#</a> A 外部跟随:</h4> <p>用例：要在一个移动的 moveingSprite 上添加一个Spine子节点，Spine的贴图无法参与合批，通常这会导致合批被打断。</p> <p>更好的办法：Spine子节点添加到整个舞台的最高层级，这样Spine就不是 moveingSprite 的子节点，不会打断底层元素的合批。 而在Spine节点的<code>upadate()</code>方法中，根据 moveingSprite 的位置变化自身位置。</p> <h4 id="节点二次添加"><a href="#节点二次添加" class="header-anchor">#</a> 节点二次添加:</h4> <p>用例：prefab UI 文件中，若干个 spriteButton 上都包含了一些文本框 cc.Label 子节点，这些 cc.Label 会打断 spriteButton 和其他元素的合批。</p> <p>处理方法：重排UI层级。先遍历所有UI节点，将不能参与合批的子节点找出来，记录它们的全局坐标。重设这些子节点的 parent 或者 removeSelf 后再 addChild 它们，将它们添加到UI的最上层，并根据全局坐标重设位置。这样能参与合批的元素drawCalls将为1。</p> <h3 id="_2-粒子和spine"><a href="#_2-粒子和spine" class="header-anchor">#</a> 2. 粒子和Spine</h3> <p>粒子和Spine动画，往往会使用不属于全局图集的纹理。要注意将他们的层级和其他参与合批的内容分离。</p> <h3 id="_3-cc-graphics"><a href="#_3-cc-graphics" class="header-anchor">#</a> 3. cc.Graphics</h3> <p>cc.Graphics 直接调用GL的图形绘制API。 他也是无法参与全局合批的元素。 不仅如此，因为引擎的问题（直到2.3.3依然存在），即便是相同颜色的cc.Graphics节点，cocos都无法做到合批（理论上可以做到）。所以在引擎解决整个问题之前，项目要尽量避免 cc.Graphics 的使用。或者对引擎底层做修改，让 cc.Graphics 之间能够合批。</p> <br> <h2 id="八-压缩纹理"><a href="#八-压缩纹理" class="header-anchor">#</a> 八. 压缩纹理</h2> <p>绑定压缩纹理是 OpenGL/WebGL 自身支持的一个特性。</p> <p>压缩纹理的使用并不会减少drawCalls, 甚至压缩纹理的 shader 比默认的非压缩纹理 shader 还稍微复杂那么一点点：</p> <p>注意 builtin-2d-sprite.effect：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>  <span class="token keyword">void</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vec4 o <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TEXTURE</span></span>
    o <span class="token operator">*=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_uv0<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CC_USE_ALPHA_ATLAS_TEXTURE </span><span class="token comment">//如果是 etc 1.0 这样的压缩纹理，要对透明通道做特殊处理</span></span>
      o<span class="token punctuation">.</span>a <span class="token operator">*=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> v_uv0 <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span>
      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    o <span class="token operator">*=</span> v_color<span class="token punctuation">;</span>
 
    <span class="token function">ALPHA_TEST</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    gl_FragColor <span class="token operator">=</span> o<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>压缩纹理的主要作用是降低程序的内存占用。比如使用etc 1.0，可以让纹理占用的内存空间压缩到原来的 1/3。</p> <p>所以，“压缩纹理” 其实不太符合“渲染性能优化”这个话题，它对渲染性能的影响是间接的（通过内存的优化）。只是本篇已经做了不少关于纹理资源的讨论，压缩纹理作为这方面的课题也应该带一下。</p> <p><a href="http://docs.cocos.com/creator/manual/zh/asset-workflow/compress-texture.html?h=%E5%8E%8B%E7%BC%A9" title="Cocos官方压缩纹理介绍" target="_blank" rel="noopener noreferrer">Cocos官方压缩纹理介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>cocosCreator 2.x 可以做到在项目在构建时针对不同的平台，不同的图片文件，生成不同格式的压缩纹理。这个功能大大简化了开发者自己去部署多平台压缩纹理的工作。</p> <p>虽然压缩纹理对图片的质量是有影响的（有损压缩），但是鉴于其部署的方式非常灵活。我们可以最大程度的发挥压缩纹理的优势。 （比如，对于静止的，精细度要求很高的贴图不压缩， 而对于一闪而过的帧动画特效，粒子，精度要求不高的贴图，运用压缩纹理策略。）</p> <br></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/game/04性能优化/性能指标.html" class="prev">
        关于性能优化指标
      </a></span> <span class="next"><a href="/game/04性能优化/TexturePacker.html">
        TexturePacker黑边问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7bd7f7e3.js" defer></script><script src="/assets/js/2.4a016ca1.js" defer></script><script src="/assets/js/78.d7bc09f5.js" defer></script>
  </body>
</html>
