<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Label 缓存模式 | LiCheng</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="欢迎光顾!">
    <link rel="preload" href="/assets/css/0.styles.16c06408.css" as="style"><link rel="preload" href="/assets/js/app.64f8b909.js" as="script"><link rel="preload" href="/assets/js/3.75898f6c.js" as="script"><link rel="preload" href="/assets/js/54.5c7ac6cb.js" as="script"><link rel="prefetch" href="/assets/js/10.05f7a345.js"><link rel="prefetch" href="/assets/js/100.08482688.js"><link rel="prefetch" href="/assets/js/101.e1208342.js"><link rel="prefetch" href="/assets/js/102.30de2fcd.js"><link rel="prefetch" href="/assets/js/103.e01f82d6.js"><link rel="prefetch" href="/assets/js/104.e22e10b6.js"><link rel="prefetch" href="/assets/js/105.2699d12e.js"><link rel="prefetch" href="/assets/js/106.b92f93b6.js"><link rel="prefetch" href="/assets/js/107.466c03d7.js"><link rel="prefetch" href="/assets/js/108.59976add.js"><link rel="prefetch" href="/assets/js/109.46039129.js"><link rel="prefetch" href="/assets/js/11.fc655784.js"><link rel="prefetch" href="/assets/js/110.0ab39ec6.js"><link rel="prefetch" href="/assets/js/111.01f0783d.js"><link rel="prefetch" href="/assets/js/112.4a185f9c.js"><link rel="prefetch" href="/assets/js/113.eb14de15.js"><link rel="prefetch" href="/assets/js/114.0fa73b35.js"><link rel="prefetch" href="/assets/js/115.8d18dcda.js"><link rel="prefetch" href="/assets/js/116.e42d8533.js"><link rel="prefetch" href="/assets/js/117.d5a956ea.js"><link rel="prefetch" href="/assets/js/118.0417673c.js"><link rel="prefetch" href="/assets/js/119.9783725b.js"><link rel="prefetch" href="/assets/js/12.195019d1.js"><link rel="prefetch" href="/assets/js/120.2687a476.js"><link rel="prefetch" href="/assets/js/121.b14af246.js"><link rel="prefetch" href="/assets/js/122.d1cea1e4.js"><link rel="prefetch" href="/assets/js/123.277379df.js"><link rel="prefetch" href="/assets/js/124.c05b55e5.js"><link rel="prefetch" href="/assets/js/125.402e09f1.js"><link rel="prefetch" href="/assets/js/126.0e78faaa.js"><link rel="prefetch" href="/assets/js/127.9c3fa126.js"><link rel="prefetch" href="/assets/js/128.98831faa.js"><link rel="prefetch" href="/assets/js/129.4e9d858f.js"><link rel="prefetch" href="/assets/js/13.f835ac11.js"><link rel="prefetch" href="/assets/js/130.f06d28bf.js"><link rel="prefetch" href="/assets/js/131.1584ab07.js"><link rel="prefetch" href="/assets/js/132.e74fc693.js"><link rel="prefetch" href="/assets/js/133.245e7af1.js"><link rel="prefetch" href="/assets/js/134.2cc13cdb.js"><link rel="prefetch" href="/assets/js/135.abcddfe1.js"><link rel="prefetch" href="/assets/js/136.0d61458c.js"><link rel="prefetch" href="/assets/js/137.8b15c731.js"><link rel="prefetch" href="/assets/js/138.13fc352e.js"><link rel="prefetch" href="/assets/js/139.584d663f.js"><link rel="prefetch" href="/assets/js/14.d672bc9e.js"><link rel="prefetch" href="/assets/js/140.f253cbf4.js"><link rel="prefetch" href="/assets/js/141.1f4289c6.js"><link rel="prefetch" href="/assets/js/142.55905084.js"><link rel="prefetch" href="/assets/js/143.aff066ff.js"><link rel="prefetch" href="/assets/js/144.ae374c87.js"><link rel="prefetch" href="/assets/js/145.b25b7a31.js"><link rel="prefetch" href="/assets/js/146.38106f68.js"><link rel="prefetch" href="/assets/js/147.5531adf9.js"><link rel="prefetch" href="/assets/js/148.9a90f122.js"><link rel="prefetch" href="/assets/js/149.d2d15d00.js"><link rel="prefetch" href="/assets/js/15.5411dc99.js"><link rel="prefetch" href="/assets/js/150.b0ef8d4d.js"><link rel="prefetch" href="/assets/js/151.be4414b4.js"><link rel="prefetch" href="/assets/js/152.d15ccf31.js"><link rel="prefetch" href="/assets/js/153.2382887b.js"><link rel="prefetch" href="/assets/js/154.11c8f650.js"><link rel="prefetch" href="/assets/js/155.cc3b3a0d.js"><link rel="prefetch" href="/assets/js/156.3dc720ef.js"><link rel="prefetch" href="/assets/js/157.588e94da.js"><link rel="prefetch" href="/assets/js/158.0ed0cf47.js"><link rel="prefetch" href="/assets/js/159.018aed58.js"><link rel="prefetch" href="/assets/js/16.b5ce7c9a.js"><link rel="prefetch" href="/assets/js/160.b26d8e89.js"><link rel="prefetch" href="/assets/js/161.0fcf231d.js"><link rel="prefetch" href="/assets/js/162.7afdaa7b.js"><link rel="prefetch" href="/assets/js/163.c2dc1c0e.js"><link rel="prefetch" href="/assets/js/164.3683e0a5.js"><link rel="prefetch" href="/assets/js/165.f5e97141.js"><link rel="prefetch" href="/assets/js/166.238b0cdd.js"><link rel="prefetch" href="/assets/js/167.03545b6c.js"><link rel="prefetch" href="/assets/js/168.d5c820fe.js"><link rel="prefetch" href="/assets/js/169.911372c0.js"><link rel="prefetch" href="/assets/js/17.e3de3b03.js"><link rel="prefetch" href="/assets/js/170.6b960093.js"><link rel="prefetch" href="/assets/js/171.0cf4f431.js"><link rel="prefetch" href="/assets/js/172.f36438a3.js"><link rel="prefetch" href="/assets/js/173.f4637dc2.js"><link rel="prefetch" href="/assets/js/174.afdc90d8.js"><link rel="prefetch" href="/assets/js/175.a3ca1d5c.js"><link rel="prefetch" href="/assets/js/176.952b13ab.js"><link rel="prefetch" href="/assets/js/177.1043653b.js"><link rel="prefetch" href="/assets/js/178.cabd9053.js"><link rel="prefetch" href="/assets/js/179.5e621808.js"><link rel="prefetch" href="/assets/js/18.d89c0fc3.js"><link rel="prefetch" href="/assets/js/180.edbf431b.js"><link rel="prefetch" href="/assets/js/181.03f4c5fe.js"><link rel="prefetch" href="/assets/js/182.2795da48.js"><link rel="prefetch" href="/assets/js/183.1c2194a7.js"><link rel="prefetch" href="/assets/js/184.a05670d6.js"><link rel="prefetch" href="/assets/js/185.c6358950.js"><link rel="prefetch" href="/assets/js/186.56d315aa.js"><link rel="prefetch" href="/assets/js/187.f878b6dc.js"><link rel="prefetch" href="/assets/js/188.0bd06960.js"><link rel="prefetch" href="/assets/js/189.702cfb45.js"><link rel="prefetch" href="/assets/js/19.e3727794.js"><link rel="prefetch" href="/assets/js/190.fd29a6dd.js"><link rel="prefetch" href="/assets/js/191.19e3bc77.js"><link rel="prefetch" href="/assets/js/192.2068db6a.js"><link rel="prefetch" href="/assets/js/193.c56c0518.js"><link rel="prefetch" href="/assets/js/194.f6c41aac.js"><link rel="prefetch" href="/assets/js/195.80f800ef.js"><link rel="prefetch" href="/assets/js/196.43e40fc1.js"><link rel="prefetch" href="/assets/js/197.ff12aad7.js"><link rel="prefetch" href="/assets/js/2.9c8bf6db.js"><link rel="prefetch" href="/assets/js/20.2a0c334c.js"><link rel="prefetch" href="/assets/js/21.9810f78f.js"><link rel="prefetch" href="/assets/js/22.4a772441.js"><link rel="prefetch" href="/assets/js/23.a09a0006.js"><link rel="prefetch" href="/assets/js/24.f1fba42e.js"><link rel="prefetch" href="/assets/js/25.f04cf154.js"><link rel="prefetch" href="/assets/js/26.fd65d800.js"><link rel="prefetch" href="/assets/js/27.39ab2dee.js"><link rel="prefetch" href="/assets/js/28.e1e7ab21.js"><link rel="prefetch" href="/assets/js/29.27796f9e.js"><link rel="prefetch" href="/assets/js/30.59ff8c02.js"><link rel="prefetch" href="/assets/js/31.01c482ab.js"><link rel="prefetch" href="/assets/js/32.56a48bbe.js"><link rel="prefetch" href="/assets/js/33.f1bdc5cc.js"><link rel="prefetch" href="/assets/js/34.5734cbb6.js"><link rel="prefetch" href="/assets/js/35.16de61d8.js"><link rel="prefetch" href="/assets/js/36.454dbfe6.js"><link rel="prefetch" href="/assets/js/37.464ca36d.js"><link rel="prefetch" href="/assets/js/38.55a33281.js"><link rel="prefetch" href="/assets/js/39.ab26b3e2.js"><link rel="prefetch" href="/assets/js/4.568c15af.js"><link rel="prefetch" href="/assets/js/40.e5ef713c.js"><link rel="prefetch" href="/assets/js/41.0b46ee29.js"><link rel="prefetch" href="/assets/js/42.26de45e7.js"><link rel="prefetch" href="/assets/js/43.7435dcfc.js"><link rel="prefetch" href="/assets/js/44.6b81f477.js"><link rel="prefetch" href="/assets/js/45.c8f17d04.js"><link rel="prefetch" href="/assets/js/46.9caf5672.js"><link rel="prefetch" href="/assets/js/47.dffa21fb.js"><link rel="prefetch" href="/assets/js/48.42e70cdd.js"><link rel="prefetch" href="/assets/js/49.1ea3a1f4.js"><link rel="prefetch" href="/assets/js/5.58d62a17.js"><link rel="prefetch" href="/assets/js/50.d72b59cf.js"><link rel="prefetch" href="/assets/js/51.81578443.js"><link rel="prefetch" href="/assets/js/52.d0067e7f.js"><link rel="prefetch" href="/assets/js/53.e69ba3f4.js"><link rel="prefetch" href="/assets/js/55.36d9be2c.js"><link rel="prefetch" href="/assets/js/56.a985bc5f.js"><link rel="prefetch" href="/assets/js/57.822ad5e4.js"><link rel="prefetch" href="/assets/js/58.aaa38887.js"><link rel="prefetch" href="/assets/js/59.c662cec9.js"><link rel="prefetch" href="/assets/js/6.8b83e934.js"><link rel="prefetch" href="/assets/js/60.b79437d3.js"><link rel="prefetch" href="/assets/js/61.6cdf996f.js"><link rel="prefetch" href="/assets/js/62.3d491f85.js"><link rel="prefetch" href="/assets/js/63.1bc683dd.js"><link rel="prefetch" href="/assets/js/64.1fb22532.js"><link rel="prefetch" href="/assets/js/65.a61efd03.js"><link rel="prefetch" href="/assets/js/66.d299fb1d.js"><link rel="prefetch" href="/assets/js/67.5a5b352d.js"><link rel="prefetch" href="/assets/js/68.8fa2cdb5.js"><link rel="prefetch" href="/assets/js/69.1e01fe15.js"><link rel="prefetch" href="/assets/js/7.9846b46d.js"><link rel="prefetch" href="/assets/js/70.c4d82f01.js"><link rel="prefetch" href="/assets/js/71.10dbb36d.js"><link rel="prefetch" href="/assets/js/72.20514fe7.js"><link rel="prefetch" href="/assets/js/73.0b44ea44.js"><link rel="prefetch" href="/assets/js/74.e08158fa.js"><link rel="prefetch" href="/assets/js/75.0cebca84.js"><link rel="prefetch" href="/assets/js/76.172187c5.js"><link rel="prefetch" href="/assets/js/77.51640200.js"><link rel="prefetch" href="/assets/js/78.7ff71ad8.js"><link rel="prefetch" href="/assets/js/79.986bd02a.js"><link rel="prefetch" href="/assets/js/8.9a5053bf.js"><link rel="prefetch" href="/assets/js/80.f129f224.js"><link rel="prefetch" href="/assets/js/81.565ab710.js"><link rel="prefetch" href="/assets/js/82.ceb4157e.js"><link rel="prefetch" href="/assets/js/83.ed28998f.js"><link rel="prefetch" href="/assets/js/84.37f91a6d.js"><link rel="prefetch" href="/assets/js/85.fa538407.js"><link rel="prefetch" href="/assets/js/86.8faabea2.js"><link rel="prefetch" href="/assets/js/87.ee1da025.js"><link rel="prefetch" href="/assets/js/88.3b6809d5.js"><link rel="prefetch" href="/assets/js/89.f04a931c.js"><link rel="prefetch" href="/assets/js/9.f513f9ab.js"><link rel="prefetch" href="/assets/js/90.9b42b3f8.js"><link rel="prefetch" href="/assets/js/91.90fda6fc.js"><link rel="prefetch" href="/assets/js/92.c41a0d88.js"><link rel="prefetch" href="/assets/js/93.b3d33173.js"><link rel="prefetch" href="/assets/js/94.f2b0052c.js"><link rel="prefetch" href="/assets/js/95.10b09ed9.js"><link rel="prefetch" href="/assets/js/96.c054d48f.js"><link rel="prefetch" href="/assets/js/97.477bc0c7.js"><link rel="prefetch" href="/assets/js/98.2482c76b.js"><link rel="prefetch" href="/assets/js/99.a7f3a99e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16c06408.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="LiCheng" class="logo"> <span class="site-name can-hide">LiCheng</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/product/" class="nav-link">
  产品
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/game/" class="nav-link router-link-active">
  游戏
</a></div><div class="nav-item"><a href="/product/" class="nav-link">
  产品
</a></div><div class="nav-item"><a href="/ios/" class="nav-link">
  iOS
</a></div><div class="nav-item"><a href="/essay/" class="nav-link">
  好文
</a></div><div class="nav-item"><a href="https://github.com/LiCheng244/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/game/00基础知识/" class="sidebar-heading clickable"><span>基础知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/01JavaScript/" class="sidebar-heading clickable"><span>JavaScript</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/game/02TypeScript/" class="sidebar-link">TypeScript</a></li><li><a href="/game/03%E5%BE%AE%E4%BF%A1%E5%B0%8F%E6%B8%B8%E6%88%8F/" class="sidebar-link">微信小游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/04性能优化/" class="sidebar-heading clickable"><span>性能优化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/05Creator/" class="sidebar-heading clickable router-link-active open"><span>Creator</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/game/05Creator/node.html" class="sidebar-link">节点常用 API</a></li><li><a href="/game/05Creator/组件生命周期.html" class="sidebar-link">脚本组件生命周期</a></li><li><a href="/game/05Creator/Lable缓存模式.html" class="active sidebar-link">Label 缓存模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/game/05Creator/Lable缓存模式.html#一-缓存类型" class="sidebar-link">一. 缓存类型</a></li><li class="sidebar-sub-header"><a href="/game/05Creator/Lable缓存模式.html#二-char-无限模式" class="sidebar-link">二. CHAR 无限模式</a></li><li class="sidebar-sub-header"><a href="/game/05Creator/Lable缓存模式.html#三-无限模式解决方案" class="sidebar-link">三. 无限模式解决方案</a></li></ul></li><li><a href="/game/05Creator/Lable获取高度.html" class="sidebar-link">Label 获取高度</a></li><li><a href="/game/05Creator/摄像机.html" class="sidebar-link">Camera 摄像机</a></li><li><a href="/game/05Creator/AssetBundle.html" class="sidebar-link">Asset Bundle 全解析</a></li><li><a href="/game/05Creator/无法定位错误.html" class="sidebar-link">处理2.3.3无法定位错误</a></li><li><a href="/game/05Creator/loading页.html" class="sidebar-link">处理cocos自带loading页</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/game/06面试题/" class="sidebar-heading clickable"><span>面试题</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1>Label 缓存模式</h1> <div class="custom-block tip"><p class="custom-block-title">前言</p> <p>根据实际应用场景设置 Label 的 <code>Cache Mode</code> 属性，可以有效的优化 Label 绘制，减少 Drawcall。</p></div> <br> <h2 id="一-缓存类型"><a href="#一-缓存类型" class="header-anchor">#</a> 一. 缓存类型</h2> <p><img src="/assets/img/220111200.15141a08.png" alt=""></p> <h3 id="_1-none"><a href="#_1-none" class="header-anchor">#</a> 1. NONE:</h3> <p>默认值，会将 <code>Label</code> 中的整段文本将生成一张位图， 但是并不参与动态合图。</p> <p>不做任何缓存，文本内容进行一次绘制。</p> <h3 id="_2-bitmap"><a href="#_2-bitmap" class="header-anchor">#</a> 2. BITMAP:</h3> <p><code>『 将文本作为静态图像加入动态图集进行批次合并，但是不能频繁动态修改文本内容 』</code>。</p> <p>选择后，Label 中的整段文本仍将生成一张位图，但是会尽量参与 动态合图。只要满足动态合图的要求，就会和动态合图中的其它 Sprite 或者 Label 合并 Draw Call。由于动态合图会占用更多内存，<strong>该模式只能用于文本不常更新的 Label</strong>。</p> <p>和 NONE 模式一样，BITMAP 模式会强制给每个 Label 组件生成一张位图，不论文本内容是否等同。如果场景中有大量相同文本的 Label，建议使用 CHAR 模式以复用内存空间。</p> <h3 id="_3-char"><a href="#_3-char" class="header-anchor">#</a> 3. CHAR:</h3> <p>原理类似 <code>BMFont</code>，Label 将以“字”为单位将文本缓存到全局共享的位图中，相同字体样式和字号的每个字符将在全局共享一份缓存。能支持文本的频繁修改，对性能和内存最友好。</p> <p>不过目前该模式还存在如下限制，我们将在后续的版本中进行优化：</p> <ol><li><strong>该模式只能用于字体样式和字号固定（通过记录字体的 fontSize、fontFamily、color、outline 为关键信息，以此进行字符的重复使用，其他有使用特殊自定义文本格式的需要注意），并且不会频繁出现巨量未使用过的字符的 Label</strong>。这是为了节约缓存，因为全局共享的位图尺寸为 2048*2048，只有场景切换时才会清除，一旦位图被占满后新出现的字符将无法渲染。</li> <li>不能参与动态合图（同样启用 CHAR 模式的多个 Label 在渲染顺序不被打断的情况下仍然能合并 Draw Call）</li></ol> <h4 id="风险："><a href="#风险：" class="header-anchor">#</a> 风险：</h4> <p>字符图集的大小是受限的，总大小只有2048*2048。这里带来的风险是，不能无限制地使用 CHAR 模式来显示文字，因为有可能在图集重建之前把图集用完，用完的结果将导致后续使用 CHAR 模式的 Label 无法再正常显示文字，因为新的字符无法再往这张唯一的图集中继续添加了。</p> <h3 id="_4-注意："><a href="#_4-注意：" class="header-anchor">#</a> 4. 注意：</h3> <ol><li>Cache Mode 对所有平台都有优化效果。</li> <li>BITMAP 模式取代了原先的 <code>Batch As Bitmap</code> 选项，旧项目如启用了 <code>Batch As Bitmap</code> 将自动迁移至该选项。</li> <li>使用缓存模式时不能剔除 <strong>项目 -&gt; 项目设置 -&gt; 模块设置</strong> 面板中的 <code>RenderTexture</code> 模块。</li></ol> <h3 id="_5-总结："><a href="#_5-总结：" class="header-anchor">#</a> 5. 总结：</h3> <table><thead><tr><th style="text-align:left;">Cache Mode</th> <th style="text-align:left;">文本图片</th> <th style="text-align:left;">最佳实践</th></tr></thead> <tbody><tr><td style="text-align:left;">NONE</td> <td style="text-align:left;">单个 Label 使用一张节点大小的图片</td> <td style="text-align:left;">适用频繁更新的不定文本，如：聊天功能</td></tr> <tr><td style="text-align:left;">BITMAP</td> <td style="text-align:left;">文本修改需要重绘，绘制后添加到 2048x2048 的通用动态图集中</td> <td style="text-align:left;">适用内容不会改变的静态文本，如：界面标题</td></tr> <tr><td style="text-align:left;">CHAR</td> <td style="text-align:left;">每个字符绘制一次并添加到 2048x2048 的字符图集中</td> <td style="text-align:left;">适用频繁更新且文本字符内容有限的文本，如：分数、倒计时等</td></tr></tbody></table> <br> <h2 id="二-char-无限模式"><a href="#二-char-无限模式" class="header-anchor">#</a> 二. CHAR 无限模式</h2> <p><code>『 在唯一的一张图集上重复利用 』</code>。</p> <p>这个思路的难点有如下几个：</p> <ol><li>如何判断某个字符已经是废弃状态？</li> <li>如何快速找到一个可被重复利用的合适的字符在图集中的位置？</li> <li>如果找不到一个合适的可重复利用的字符，还有没有可利用的新的图集空间容纳新的字符？</li></ol> <h3 id="_1-难点分析"><a href="#_1-难点分析" class="header-anchor">#</a> 1. 难点分析</h3> <h4 id="a-如何判断某个字符已经是废弃状态？"><a href="#a-如何判断某个字符已经是废弃状态？" class="header-anchor">#</a> a. 如何判断某个字符已经是废弃状态？</h4> <p>文字图集上的每个字符可以用字典记录下它的位置和大小信息，还有一个是被引用的次数。</p> <p>判断废弃的状态，可以通过对这个字符的引用次数来决定，例如一个 CHAR 模式的文本&quot;abcaddae&quot;渲染时，a字符的引用次数是3，b是1，c是1，d是2，e是1，那么文本被移除时，减除相应的引用计数即可。当某个字符的引用计数为0时，即代表它所占的图集位置是个废弃的状态，可以被回收再利用。</p> <h4 id="b-如何快速找到一个可被重复利用的合适的字符在图集中的位置？"><a href="#b-如何快速找到一个可被重复利用的合适的字符在图集中的位置？" class="header-anchor">#</a> b. 如何快速找到一个可被重复利用的合适的字符在图集中的位置？</h4> <p>在第一点里面，我们创建的字符和图集位置的映射里面，有位置信息和大小信息。先筛选废弃状态再通过大小判断是不能容纳新的字符即可找到可重复利用的目标字符位置。</p> <h4 id="c-如果找不到一个合适的可重复利用的字符，还有没有可利用的新的图集空间容纳新的字符？"><a href="#c-如果找不到一个合适的可重复利用的字符，还有没有可利用的新的图集空间容纳新的字符？" class="header-anchor">#</a> c. 如果找不到一个合适的可重复利用的字符，还有没有可利用的新的图集空间容纳新的字符？</h4> <p>这个问题比较好解决，我们在 2048*2048 的图集上，拿出一部分空间作为保留空间先不使用。</p> <p>查找空间时，先查找非保留空间是不有合适位置，再查找是不有可重复利用的废弃空间。如果还没有，再到保留空间里面来添加新字符。</p> <p>当然有人会说，如果保留空间也被使用完了怎么办？这个优化方案可以拉到文末查看。</p> <br> <h2 id="三-无限模式解决方案"><a href="#三-无限模式解决方案" class="header-anchor">#</a> 三. 无限模式解决方案</h2> <p>这里，我们以获取字符图集的接口 <code>getLetterDefinitionForChar（letter-font.js）</code>为突破口，这个接口是用来查找并添加新的字符，<strong>新的查找思路如下：</strong></p> <h3 id="_1-查询字是否存在"><a href="#_1-查询字是否存在" class="header-anchor">#</a> 1. 查询字是否存在</h3> <p><strong>是否已经在当前 <code>this._fontDefDictionary._letterDefinitions</code> 中存在？</strong></p> <p>存在则直接返回。这是当前的流程中已经有的，保留即可！</p> <h3 id="_2-查找图集安全区"><a href="#_2-查找图集安全区" class="header-anchor">#</a> 2. 查找图集安全区</h3> <p><strong>当前字符图集的安全区是否有足够空间插入新的字符？</strong></p> <p>足够则执行添加新字符的流程。在 <code>LetterAtlas</code> 中添加字段 <code>_safeHeight</code> 用于保存当前安全区的图集高度：即 2048 的高度中有多少是可以随意添加字符集的，这里直接乘以自己设定的比例即可。</p> <p>具体的查找过程是：</p> <h4 id="a-计算新添加的字符的显示高度与宽度："><a href="#a-计算新添加的字符的显示高度与宽度：" class="header-anchor">#</a> a. 计算新添加的字符的显示高度与宽度：</h4> <p>通过 <code>textUtils.safeMeasureText</code> 来计算。</p> <h4 id="b-在图集的当前游标位置添加新的字符是否能成功？"><a href="#b-在图集的当前游标位置添加新的字符是否能成功？" class="header-anchor">#</a> b. 在图集的当前游标位置添加新的字符是否能成功？</h4> <p>宽度超过 2048，或高度超过 <code>_safeHeight</code> 都算失败:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token function">canInsertLabel</span><span class="token punctuation">(</span><span class="token parameter">labelInfo<span class="token punctuation">,</span> char<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">let</span> sizeArr <span class="token operator">=</span> LetterTexture<span class="token punctuation">.</span><span class="token function">calcTextSize</span><span class="token punctuation">(</span>labelInfo<span class="token punctuation">,</span>char<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> width <span class="token operator">=</span> sizeArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> height <span class="token operator">=</span> sizeArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> nextY <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_nexty<span class="token punctuation">;</span>
        <span class="token keyword">let</span> thisY <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_y<span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">+</span> width <span class="token operator">+</span> space<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_width<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thisY <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_nexty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>thisY <span class="token operator">+</span> height<span class="token punctuation">)</span> <span class="token operator">&gt;</span> nextY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextY <span class="token operator">=</span> thisY <span class="token operator">+</span> height <span class="token operator">+</span> space<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> maxY <span class="token operator">=</span> force <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_height <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_safeHeight<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextY <span class="token operator">&gt;</span> maxY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="c-能够添加，则走当前的插入新字符的流程"><a href="#c-能够添加，则走当前的插入新字符的流程" class="header-anchor">#</a> c. 能够添加，则走当前的插入新字符的流程:</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">let</span> <span class="token function-variable function">_insertNewLetter</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LetterTexture</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> labelInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span><span class="token function">updateRenderData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> _letter <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">insertLetterTexture</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _letter<span class="token punctuation">.</span>char <span class="token operator">=</span> char<span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span><span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _letter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-在废弃的字符统计中查找合适的字符大小"><a href="#_3-在废弃的字符统计中查找合适的字符大小" class="header-anchor">#</a> 3. 在废弃的字符统计中查找合适的字符大小</h3> <p>在废弃的字符统计中查找合适的字符大小，如果能找到，则执行废弃字符再复用流程。</p> <p>在 letter-font.js 中添加字段：<code>let _unusedLetterList = [];</code></p> <p>用于收集已经废弃的字符数组。数组里面存储的是 <code>FontLetterDefinition</code> 对象。当然 <code>FontLetterDefinition</code> 对象也需要新加几个字段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 字符宽高用于后续被重新复用时判断是否能容纳下新的字符</span>
letter<span class="token punctuation">.</span>originW <span class="token operator">=</span> letterTexture<span class="token punctuation">.</span>_width<span class="token punctuation">;</span>
letter<span class="token punctuation">.</span>originH <span class="token operator">=</span> letterTexture<span class="token punctuation">.</span>_height<span class="token punctuation">;</span>
<span class="token comment">// hash值是这个TTF字符的唯一标识，由颜色，字号，字体，描边等信息组成</span>
letter<span class="token punctuation">.</span>hash <span class="token operator">=</span> letterTexture<span class="token punctuation">.</span>_hash<span class="token punctuation">;</span>
<span class="token comment">// 引用计数用于统计当前字符被引用的次数，判断是否是废弃状态</span>
letter<span class="token punctuation">.</span>refCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="查找方法-findunsedletterfor-char-的逻辑是："><a href="#查找方法-findunsedletterfor-char-的逻辑是：" class="header-anchor">#</a> 查找方法 <code>findUnsedLetterFor(char)</code> 的逻辑是：</h4> <ul><li>判断数组 <code>_unusedLetterList</code> 是否为空，如果为空则返回 null；</li> <li>逐个判断废弃字符的 <code>originW</code>, <code>originH</code> 是否 &gt;= 当前新字符。（后期优化查找效率和命中率的位置就在这里）；</li> <li>找到则返回当前的 <code>FontLetterDefinition</code> 对象，否则返回n ull。</li></ul> <p>如果 <code>findUnsedLetterFor</code> 的返回值不为 null，则可以直接调用 <code>replaceLetterTexture</code> 方法在废弃字符的位置上画上新的字符。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token function">replaceLetterTexture</span><span class="token punctuation">(</span><span class="token parameter">oldLetter<span class="token punctuation">,</span> lerrerTexture<span class="token punctuation">,</span> char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">let</span> oldHash <span class="token operator">=</span> oldLetter<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
        <span class="token keyword">let</span> texture <span class="token operator">=</span> lerrerTexture<span class="token punctuation">.</span>_texture<span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_fontDefDictionary<span class="token punctuation">.</span>_texture<span class="token punctuation">.</span><span class="token function">drawTextureAt</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> oldLetter<span class="token punctuation">.</span>u<span class="token operator">-</span>bleed<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> oldLetter<span class="token punctuation">.</span>v<span class="token operator">-</span>bleed<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        oldLetter<span class="token punctuation">.</span>hash <span class="token operator">=</span> lerrerTexture<span class="token punctuation">.</span>_hash<span class="token punctuation">;</span>
        oldLetter<span class="token punctuation">.</span>w <span class="token operator">=</span> lerrerTexture<span class="token punctuation">.</span>_width <span class="token operator">-</span> bleed<span class="token punctuation">;</span>
        oldLetter<span class="token punctuation">.</span>h <span class="token operator">=</span> lerrerTexture<span class="token punctuation">.</span>_height <span class="token operator">-</span> bleed<span class="token punctuation">;</span>
        oldLetter<span class="token punctuation">.</span>offsetY <span class="token operator">=</span> lerrerTexture<span class="token punctuation">.</span>_offsetY<span class="token punctuation">;</span>
        oldLetter<span class="token punctuation">.</span>refCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>_fontDefDictionary<span class="token punctuation">.</span><span class="token function">addLetterDefinitions</span><span class="token punctuation">(</span>lerrerTexture<span class="token punctuation">.</span>_hash<span class="token punctuation">,</span> oldLetter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_fontDefDictionary<span class="token punctuation">.</span>_letterDefinitions<span class="token punctuation">[</span>oldHash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> oldLetter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="_4-在保留区域内判断是否有足够空间添加新字符"><a href="#_4-在保留区域内判断是否有足够空间添加新字符" class="header-anchor">#</a> 4. 在保留区域内判断是否有足够空间添加新字符</h3> <p>在保留区域内判断是否有足够空间添加新字符，如果有，则执行插入流程。</p> <p>如果执行到这一步，说明新插入的字符大号比较大，前面显示的字符中都未出现过。那么就需要尝试在保留区域内去插入新的字符，这里和前面在安全区内插入字符是同样的过程，不同的是 <code>canInsertLabel</code> 接口的 force 参数传入 true 即可在保留区域内去搜索图集位置。</p> <h3 id="_5-否则报错！"><a href="#_5-否则报错！" class="header-anchor">#</a> 5. 否则报错！</h3> <p>经过以上所有步骤都无法找到合适的图集时，就要报错提醒了。</p> <p><a href="https://mp.weixin.qq.com/s/NUjDaE0WAP3tf3G571GSsw#" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <br> <br></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/game/05Creator/组件生命周期.html" class="prev">
        脚本组件生命周期
      </a></span> <span class="next"><a href="/game/05Creator/Lable获取高度.html">
        Label 获取高度
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.64f8b909.js" defer></script><script src="/assets/js/3.75898f6c.js" defer></script><script src="/assets/js/54.5c7ac6cb.js" defer></script>
  </body>
</html>
